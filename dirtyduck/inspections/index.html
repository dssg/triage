
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Documentation for Triage." name="description"/>
<link href="http://dssg.github.io/triage/dirtyduck/inspections/" rel="canonical"/>
<link href="../../assets/images/favicon.ico" rel="shortcut icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-5.4.0" name="generator"/>
<title>Resource prioritization - Triage Documentation</title>
<link href="../../assets/stylesheets/main.fe0cca5b.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.a46bcfb3.min.css" rel="stylesheet"/>
<meta content="#546e7a" name="theme-color"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CUbuntu+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Ubuntu",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
<link href="../../triage_docs.css" rel="stylesheet"/>
</head>
<body data-md-color-accent="deep-orange" data-md-color-primary="blue-grey" data-md-color-scheme="" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#resource-prioritization-systems-chicago-food-inspections">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header-nav md-grid">
<a aria-label="Triage Documentation" class="md-header-nav__button md-logo" href="http://dssg.github.io/triage" title="Triage Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 22a2 2 0 002-2V4a2 2 0 00-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 00-2 2v16a2 2 0 002 2h12z"></path></svg>
</a>
<label class="md-header-nav__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header-nav__title" data-md-component="header-title">
<div class="md-header-nav__ellipsis">
<span class="md-header-nav__topic md-ellipsis">
            Triage Documentation
          </span>
<span class="md-header-nav__topic md-ellipsis">
            
              Resource prioritization
            
          </span>
</div>
</div>
<div class="md-header-nav__source">
<a class="md-source" href="http://github.com/dssg/triage/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    dssg/triage
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Triage Documentation" class="md-nav__button md-logo" href="http://dssg.github.io/triage" title="Triage Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 22a2 2 0 002-2V4a2 2 0 00-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 00-2 2v16a2 2 0 002 2h12z"></path></svg>
</a>
    Triage Documentation
  </label>
<div class="md-nav__source">
<a class="md-source" href="http://github.com/dssg/triage/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    dssg/triage
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../.." title="Home">
      Home
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" id="nav-2" type="checkbox"/>
<label class="md-nav__link" for="nav-2">
      Get started with your own project
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Get started with your own project" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-2">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Get started with your own project
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../quickstart/" title="Quickstart guide">
      Quickstart guide
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../triage_project_workflow/" title="Suggested workflow">
      Suggested workflow
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="nav-3" id="nav-3" type="checkbox"/>
<label class="md-nav__link" for="nav-3">
      Dirty Duck Tutorial
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Dirty Duck Tutorial" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-3">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Dirty Duck Tutorial
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../" title="Welcome!">
      Welcome!
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../dirty_duckling/" title="Dirty duckling">
      Dirty duckling
    </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="nav-3-3" id="nav-3-3" type="checkbox"/>
<label class="md-nav__link" for="nav-3-3">
      Case studies
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Case studies" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-3-3">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Case studies
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../problem_description/" title="Problem description">
      Problem description
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../eis/" title="Early Warning System">
      Early Warning System
    </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
        Resource prioritization
        <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"></path></svg>
</span>
</label>
<a class="md-nav__link md-nav__link--active" href="./" title="Resource prioritization">
      Resource prioritization
    </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#problem-description">
    Problem description
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#what-do-you-want-to-predict">
    What do you want to predict?
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#modeling-using-machine-learning">
    Modeling Using Machine Learning
  </a>
<nav aria-label="Modeling Using Machine Learning" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#defining-a-baseline">
    Defining a baseline
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-a-simple-experiment">
    Creating a simple experiment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#a-more-advanced-experiment">
    A more advanced experiment
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#selecting-the-best-model">
    Selecting the best model
  </a>
<nav aria-label="Selecting the best model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#filtering-model-groups">
    Filtering model groups
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#selecting-the-best-rule-or-strategy-for-choosing-model-groups">
    Selecting the best rule or strategy for choosing model groups
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#postmodeling-inspecting-the-best-models-closely">
    Postmodeling: Inspecting the best models closely
  </a>
<nav aria-label="Postmodeling: Inspecting the best models closely" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#comparing-the-audited-model-groups">
    Comparing the audited model groups
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#going-deeper-with-a-model">
    Going deeper with a model
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#where-to-go-from-here">
    Where to go from here
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-4" id="nav-3-4" type="checkbox"/>
<label class="md-nav__link" for="nav-3-4">
      Triage
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Triage" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-3-4">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Triage
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../triage_intro/" title="A deeper look into triage">
      A deeper look into triage
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-5" id="nav-3-5" type="checkbox"/>
<label class="md-nav__link" for="nav-3-5">
      Are you curious about the setup?
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Are you curious about the setup?" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-3-5">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Are you curious about the setup?
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../infrastructure/" title="Infrastructure">
      Infrastructure
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../data_preparation/" title="Data preparation">
      Data preparation
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../for_the_impatient/" title="Quick setup">
      Quick setup
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" id="nav-4" type="checkbox"/>
<label class="md-nav__link" for="nav-4">
      Triage documentation
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Triage documentation" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-4">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Triage documentation
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-1" id="nav-4-1" type="checkbox"/>
<label class="md-nav__link" for="nav-4-1">
      Experiment
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Experiment" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-1">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Experiment
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/experiment-config/" title="Experiment Configuration">
      Experiment Configuration
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/feature-testing/" title="Testing Feature Configuration">
      Testing Feature Configuration
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/running/" title="Running an Experiment">
      Running an Experiment
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-1-4" id="nav-4-1-4" type="checkbox"/>
<label class="md-nav__link" for="nav-4-1-4">
      Upgrading an Experiment
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Upgrading an Experiment" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="nav-4-1-4">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Upgrading an Experiment
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/upgrade-to-v7/" title="v6 -&gt; v7">
      v6 -&gt; v7
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/upgrade-to-v6/" title="v5 -&gt; v6">
      v5 -&gt; v6
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/upgrade-to-v5/" title="v3/v4 -&gt; v5">
      v3/v4 -&gt; v5
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/temporal-validation/" title="Temporal Validation Deep Dive">
      Temporal Validation Deep Dive
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/cohort-labels/" title="Cohort and Label Deep Dive">
      Cohort and Label Deep Dive
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/prediction-ranking/" title="Prediction Ranking">
      Prediction Ranking
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/features/" title="Feature Generation Recipe Book">
      Feature Generation Recipe Book
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/algorithm/" title="Experiment Algorithm">
      Experiment Algorithm
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../experiments/architecture/" title="Experiment Architecture">
      Experiment Architecture
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-2" id="nav-4-2" type="checkbox"/>
<label class="md-nav__link" for="nav-4-2">
      Model selection
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Model selection" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-2">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Model selection
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../audition/audition_intro/" title="Intro to Audition">
      Intro to Audition
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../audition/model_selection/" title="Model Selection Concepts">
      Model Selection Concepts
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../api/audition/" title="API Reference">
      API Reference
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-3" id="nav-4-3" type="checkbox"/>
<label class="md-nav__link" for="nav-4-3">
      Postmodeling
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Postmodeling" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-3">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Postmodeling
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../postmodeling/" title="Using Postmodeling">
      Using Postmodeling
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../postmodeling/postmodeling-config/" title="Postmodeling &amp; Crosstabs Configuration">
      Postmodeling &amp; Crosstabs Configuration
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ml_governance/" title="Model governance">
      Model governance
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../aws_batch/" title="Scaling up">
      Scaling up
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-6" id="nav-4-6" type="checkbox"/>
<label class="md-nav__link" for="nav-4-6">
      API Reference
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="API Reference" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-6">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        API Reference
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-6-1" id="nav-4-6-1" type="checkbox"/>
<label class="md-nav__link" for="nav-4-6-1">
      Audition
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Audition" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="nav-4-6-1">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Audition
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/audition/auditioner/" title="Auditioner">
      Auditioner
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/audition/audition-config/" title="Audition Configuration">
      Audition Configuration
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/audition/selection_rules/" title="Selection Rules">
      Selection Rules
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/audition/database-dependencies/" title="Database Dependencies">
      Database Dependencies
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#problem-description">
    Problem description
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#what-do-you-want-to-predict">
    What do you want to predict?
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#modeling-using-machine-learning">
    Modeling Using Machine Learning
  </a>
<nav aria-label="Modeling Using Machine Learning" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#defining-a-baseline">
    Defining a baseline
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#creating-a-simple-experiment">
    Creating a simple experiment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#a-more-advanced-experiment">
    A more advanced experiment
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#selecting-the-best-model">
    Selecting the best model
  </a>
<nav aria-label="Selecting the best model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#filtering-model-groups">
    Filtering model groups
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#selecting-the-best-rule-or-strategy-for-choosing-model-groups">
    Selecting the best rule or strategy for choosing model groups
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#postmodeling-inspecting-the-best-models-closely">
    Postmodeling: Inspecting the best models closely
  </a>
<nav aria-label="Postmodeling: Inspecting the best models closely" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#comparing-the-audited-model-groups">
    Comparing the audited model groups
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#going-deeper-with-a-model">
    Going deeper with a model
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#where-to-go-from-here">
    Where to go from here
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="http://github.com/dssg/triage/edit/master/docs/sources/dirtyduck/inspections.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg>
</a>
<h1 id="resource-prioritization-systems-chicago-food-inspections">Resource prioritization systems: Chicago food inspections<a class="headerlink" href="#resource-prioritization-systems-chicago-food-inspections" title="Permanent link">#</a></h1>
<div class="admonition warning">
<p class="admonition-title">Before continue, Did you…?</p>
<p>This case study, part of the dirtyduck tutorial,  assumes that you already setup the
tutorial’s infrastructure and load the dataset.</p>
<ul>
<li>
<p>If you didn’t setup the infrastructure go <a href="../infrastructure/">here</a>,</p>
</li>
<li>
<p>If you didn't load the data, you can do it very <a href="../for_the_impatient/">quickly</a>
  or you can follow all the <a href="../data_preparation/">steps and explanations about the data</a>.</p>
</li>
</ul>
</div>
<h2 id="problem-description">Problem description<a class="headerlink" href="#problem-description" title="Permanent link">#</a></h2>
<p>We want to generate a list of facilities that will have a <strong>critical</strong> or
<strong>serious</strong> food violation <em>if</em> inspected.</p>
<p>The scenario is the following: you work for the City of Chicago and
you have limited food inspectors, so you try to prioritize them to
focus on the highest-risk facilities. So you will use the data to
answer the next question:</p>
<div class="admonition quote">
<p>Which <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> facilities are most likely to fail a food inspection in the following <span><span class="MathJax_Preview">Y</span><script type="math/tex">Y</script></span> period of time?</p>
</div>
<p>A more technical way of writing the question is: What is the
<em>probability distribution</em> of facilities that are at <strong>risk</strong> of fail
a food inspection if they are inspected in the following period of
time?<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
<p>If you want to focus on major violations only, you can do that too:</p>
<div class="admonition quote">
<p>Which <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> facilities are most likely to have a critical or serious violation in the following <span><span class="MathJax_Preview">Y</span><script type="math/tex">Y</script></span> period of time?</p>
</div>
<p>This situation is very common in governmental agencies that provide
social services: <em>they need to prioritize their resources and use them
in the facilities that are most likely to have problems</em></p>
<p>We will use machine learning to accomplish this. This means that we
will use <em>historical</em> data to train our models, and we will use
temporal cross validation to test the performance of them.</p>
<p>For the <strong>resource prioritization</strong> problems there are commonly two
problems with the data: (a) bias and (b) incompleteness.</p>
<p>First, note that our data have bias: We only have data on facilities
that <em>were</em> inspected. That means that our data set contains
information about the probability of have a violation (<span><span class="MathJax_Preview">V</span><script type="math/tex">V</script></span>) given
that the facility was inspected (<span><span class="MathJax_Preview">I</span><script type="math/tex">I</script></span>), <span><span class="MathJax_Preview">P(V|I)</span><script type="math/tex">P(V|I)</script></span>. But the
probability that we try to find is <span><span class="MathJax_Preview">P(V)</span><script type="math/tex">P(V)</script></span>.</p>
<p>A different problem that our data set could have is if our dataset
contains <strong>all</strong> the facilities in Chicago, i.e. if our <em>entities</em>
table represents the Universe of facilities. There are almost 40,000
entities in our database. We could make the case that <strong>every</strong>
facility in Chicago is in the database, since <strong>every</strong> facility that
opens will be subject to an inspection. We will assume that <strong>all</strong>
the facilities are in our data.</p>
<h2 id="what-do-you-want-to-predict"><em>What do you want to predict?</em><a class="headerlink" href="#what-do-you-want-to-predict" title="Permanent link">#</a></h2>
<p>We are interested in two different <em>outcomes</em>:</p>
<ul>
<li><strong>Which facilities are likely to fail an inspection?</strong></li>
</ul>
<p>The outcome takes a 1 if the inspection had at least one <code>result</code> = <code>'fail'</code> and a 0 otherwise.</p>
<ul>
<li><strong>Which facilities fail an inspection with a major violation?</strong></li>
</ul>
<p>Critical violations are coded between <code>1-14</code>, serious violations
between <code>15-29</code>, everything above <code>30</code> is assumed to be a minor
violation. The label takes a 1 if the inspection had at least one
<code>result</code> = <code>'fail'</code> and a violation between 1 and 29, and a 0
otherwise.</p>
<div class="admonition info">
<p class="admonition-title">I want to learn more about the data</p>
<p>Check the <a href="/data_preparation">Data preparation</a> section!</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Data Changes</p>
<p>On 7/1/2018 the Chicago Department of Public Health’s Food
Protection unit changed the definition of violations.
The changes don’t affect structurally the dataset (e.g. how the
violations are inputted to the database), but the redefinition
will change the distribution and interpretation of the violation codes.
See
<a href="https://www.cityofchicago.org/content/dam/city/depts/cdph/FoodProtection/ChicagoFoodCodeMajorChangesFinal2018.pdf">here</a>.</p>
</div>
<p>We can extract the severity of the violation using the following code:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="n">event_id</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="k">result</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="k">distinct</span> <span class="n">obj</span> <span class="o">-&gt;&gt;</span><span class="s1">'severity'</span><span class="p">)</span> <span class="k">as</span> <span class="n">violations_severity</span><span class="p">,</span>
    <span class="p">(</span><span class="k">result</span> <span class="o">=</span> <span class="s1">'fail'</span><span class="p">)</span> <span class="k">as</span> <span class="n">failed</span><span class="p">,</span>
    <span class="n">coalesce</span><span class="p">(</span>
    <span class="p">(</span><span class="k">result</span> <span class="o">=</span> <span class="s1">'fail'</span> <span class="k">and</span>
        <span class="p">(</span><span class="s1">'serious'</span> <span class="o">=</span> <span class="k">ANY</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="n">obj</span> <span class="o">-&gt;&gt;</span> <span class="s1">'severity'</span><span class="p">))</span> <span class="k">or</span> <span class="s1">'critical'</span> <span class="o">=</span> <span class="k">ANY</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="n">obj</span> <span class="o">-&gt;&gt;</span> <span class="s1">'severity'</span><span class="p">)))</span>
        <span class="p">),</span> <span class="k">false</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">failed_major_violation</span>
<span class="k">from</span>
    <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">event_id</span><span class="p">,</span>
        <span class="n">entity_id</span><span class="p">,</span>
        <span class="nb">date</span><span class="p">,</span>
        <span class="k">result</span><span class="p">,</span>
        <span class="n">jsonb_array_elements</span><span class="p">(</span><span class="n">violations</span><span class="p">::</span><span class="n">jsonb</span><span class="p">)</span> <span class="k">as</span> <span class="n">obj</span>
    <span class="k">from</span>
        <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
        <span class="k">limit</span> <span class="mi">20</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">t1</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">entity_id</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="nb">date</span><span class="p">,</span> <span class="k">result</span>
<span class="k">order</span> <span class="k">by</span>
   <span class="nb">date</span> <span class="k">desc</span><span class="p">;</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>event_id</th>
<th>entity_id</th>
<th>date</th>
<th>result</th>
<th>violations_severity</th>
<th>failed</th>
<th>failed_major_violation</th>
</tr>
</thead>
<tbody>
<tr>
<td>1770568</td>
<td>30841</td>
<td>2016-05-11</td>
<td>pass</td>
<td>{minor}</td>
<td>f</td>
<td>f</td>
</tr>
<tr>
<td>1763967</td>
<td>30841</td>
<td>2016-05-03</td>
<td>fail</td>
<td>{critical,minor,serious}</td>
<td>t</td>
<td>t</td>
</tr>
<tr>
<td>1434534</td>
<td>21337</td>
<td>2014-04-03</td>
<td>pass</td>
<td>{NULL}</td>
<td>f</td>
<td>f</td>
</tr>
<tr>
<td>1343315</td>
<td>22053</td>
<td>2013-06-06</td>
<td>fail</td>
<td>{minor,serious}</td>
<td>t</td>
<td>t</td>
</tr>
<tr>
<td>1235707</td>
<td>21337</td>
<td>2013-03-27</td>
<td>pass</td>
<td>{NULL}</td>
<td>f</td>
<td>f</td>
</tr>
<tr>
<td>537439</td>
<td>13458</td>
<td>2011-06-10</td>
<td>fail</td>
<td>{NULL}</td>
<td>t</td>
<td>f</td>
</tr>
<tr>
<td>569377</td>
<td>5570</td>
<td>2011-06-01</td>
<td>pass</td>
<td>{NULL}</td>
<td>f</td>
<td>f</td>
</tr>
</tbody>
</table>
<p>The <em>outcome</em> will be used by <code>triage</code> to generate the <strong>labels</strong>
(once that we define a time span of interest). The
following image tries to show the meaning of the <em>outcomes</em> for the
<em>inspection failed</em> problem definition.</p>
<p><img alt="img" src="../images/outcomes-inspections.png" title="The image shows three facilities and, next to each, a temporal line with 6 days (0-5). Each dot represents an inspection. Color is the *outcome* of the inspection. Green means the facility passed the inspection, and red means it failed. Each facility in the image had two inspections, but only the facility in the middle passed both."/>
<em>Figure. The image shows three
facilities (blue, red and orange) and, next to each, a temporal line with 6 days (0-5). Each
dot represents an inspection. Color is the **outcome*</em> of the
inspection. Green means the facility passed the inspection, and red
means it failed. Each facility in the image had two inspections, but
only the facility in the middle passed both.*</p>
<h2 id="modeling-using-machine-learning">Modeling Using Machine Learning<a class="headerlink" href="#modeling-using-machine-learning" title="Permanent link">#</a></h2>
<p>It is time to put these steps together. All the coding is complete
(<code>triage</code> dev team did that for us); we just need to modify the
<code>triage</code> experiment’s configuration file.</p>
<h3 id="defining-a-baseline">Defining a baseline<a class="headerlink" href="#defining-a-baseline" title="Permanent link">#</a></h3>
<p>As a first step, lets do an experiment that defines our
<em>baseline</em>. The rationale of this is that the knowing the <em>baseline</em>
will allow us to verify if our Machine Learning model is better than
the baseline. The baseline in our example will be a <em>random selection
of facilities</em><sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>. This is implemented as a <code>DummyClassifier</code> in
<code>scikit-learn</code>. Another advantage of starting with the baseline, is
that is very fast to train (<code>DummyClassifier</code> is
not computationally expensive) , so it will help us to verify that the
experiment configuration is correct without waiting for a long time.</p>
<div class="admonition info">
<p class="admonition-title">Experiment description file</p>
<p>You could check the meaning about experiment description files
(or configuration files) in <a href="../triage_intro/"><em>A deeper look into triage</em></a>.</p>
</div>
<p>We need to write the experiment config file for that. Let's break it
down and explain their sections.</p>
<p>The config file for this first experiment is located in
<a href="https://github.com/dssg/triage/blob/master/example/dirtyduck/experiments/inspections_baseline.yaml">inspections_baseline.yaml</a>.</p>
<p>The first lines of the experiment config file specify the config-file
version (<code>v7</code> at the moment of writing this tutorial), a comment
(<code>model_comment</code>, which will end up as a value in the
<code>triage_metadata.models</code> table), and a list of user-defined metadata
(<code>user_metadata</code>) that can help to identify the resulting model
groups. For this example, if you run experiments that share a temporal
configuration but that use different label definitions (say, labeling
inspections with <strong>any</strong> violation as positive versus only labeling
inspections with major violations as positive), you can use the user
metadata keys to indicate that the matrices from these experiments
have different labeling criteria. The matrices from the two
experiments will have different filenames (and should not be
overwritten or incorrectly used), and if you add the
<code>label_definition</code> key to the <code>model_group_keys</code>, models made on
different label definitions will belong to different model groups.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Obviously, change <code>'Your name here'</code> for your name (if you like)</p>
</div>
<p>Next comes the <strong>temporal configuration</strong> section. The first four
parameters are related to the availability of data: How much data you
have for feature creation? How much data you have for label
generation?</p>
<div class="admonition warning">
<p class="admonition-title">Data Changes</p>
<p>On 7/1/2018 the Chicago Department of Public Health’s Food
Protection unit changed the definition of violations.
The changes don’t affect structurally the dataset (e.g. how the
violations are inputted to the database), but the redefinition
will change the distribution and interpretation of the violation codes.
See
<a href="https://www.cityofchicago.org/content/dam/city/depts/cdph/FoodProtection/ChicagoFoodCodeMajorChangesFinal2018.pdf">here</a>.</p>
</div>
<p>The next parameters are related to the training intervals:</p>
<ul>
<li>How frequently to retrain models? (<code>model_update_frequency</code>)</li>
<li>How many rows per entity in the train matrices? (<code>training_as_of_date_frequencies</code>)</li>
<li>How much time is covered by labels in the training matrices? (<code>training_label_timespans</code>)</li>
</ul>
<p>The remaining elements are related to the <strong>testing</strong> matrices. For <strong>inspections</strong>, you can choose them as follows:</p>
<ul>
<li><code>test_as_of_date_frequencies</code> is planning/scheduling frequency</li>
<li><code>test_durations</code> how far ahead do you schedule inspections?</li>
<li><code>test_label_timespan</code> is equal to <code>test_durations</code></li>
</ul>
<p>Let's assume that we need to do rounds of inspections every 6 months
(<code>test_as_of_date_frequencies = 6month</code>) and we need to complete that
round in exactly in that time (i.e. 6 months) (<code>test_durations = test_label_timespan =
6month</code>).</p>
<p>We will assume that the data is more or less stable<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>, at least for
now, so <code>model_update_frequency</code> = <code>6month.</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">temporal_config</span><span class="p">:</span>
    <span class="nt">feature_start_time</span><span class="p">:</span> <span class="s">'2010-01-04'</span>
    <span class="nt">feature_end_time</span><span class="p">:</span> <span class="s">'2018-06-01'</span>
    <span class="nt">label_start_time</span><span class="p">:</span> <span class="s">'2015-01-01'</span>
    <span class="nt">label_end_time</span><span class="p">:</span> <span class="s">'2018-06-01'</span>

    <span class="nt">model_update_frequency</span><span class="p">:</span> <span class="s">'6month'</span>
    <span class="nt">training_label_timespans</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'6month'</span><span class="p p-Indicator">]</span>
    <span class="nt">training_as_of_date_frequencies</span><span class="p">:</span> <span class="s">'6month'</span>

    <span class="nt">test_durations</span><span class="p">:</span> <span class="s">'0d'</span>
    <span class="nt">test_label_timespans</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'6month'</span><span class="p p-Indicator">]</span>
    <span class="nt">test_as_of_date_frequencies</span><span class="p">:</span> <span class="s">'6month'</span>

    <span class="nt">max_training_histories</span><span class="p">:</span> <span class="s">'5y'</span>
</code></pre></div>
<p>We can visualize the time splitting using the function <code>show-timechop</code>
(See <a href="../triage_intro/">A deeper look into triage</a> for more information)</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_baseline.yaml --show-timechop
</code></pre></div>
<p><img alt="img" src="../images/triage/inspections_baseline.png" title="Temporal blocks for the inspections baseline experiment"/>
<em>Figure. Temporal blocks for the inspections baseline experiment</em></p>
<p>We need to specify our labels. For this first experiment we will use
the label <code>failed</code>, using the same query from the
<code>simple_skeleton_experiment.yaml</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">label_config</span><span class="p">:</span>
  <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">select</span>
    <span class="no">entity_id,</span>
    <span class="no">bool_or(result = 'fail')::integer as outcome</span>
    <span class="no">from semantic.events</span>
    <span class="no">where '{as_of_date}'::timestamp &lt;= date</span>
    <span class="no">and date &lt; '{as_of_date}'::timestamp + interval '{label_timespan}'</span>
    <span class="no">group by entity_id</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">'failed_inspections'</span>
</code></pre></div>
<p>It should be obvious, but let's state it anyway: We are only training
in facilities that <strong>were</strong> inspected, but we will <strong>test</strong> our model
in all the facilities in our cohort<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup>. So, in the train matrices we
will have only <code>0</code> and <code>1</code> as possible labels, but in the test
matrices we will found <code>0</code>, <code>1</code> and <code>NULL</code>.</p>
<div class="admonition warning">
<p class="admonition-title">I want to learn more about this…</p>
<p>In the section regarding to <a href="../eis/"><em>Early Warning Systems</em></a> we will learn how
to incorporate <em>all</em> the facilities of the cohort in the train
matrices.</p>
</div>
<p>We just want to include <strong>active</strong> facilities in our matrices, so
we tell <code>triage</code> to take that in account:</p>
<div class="highlight"><pre><span></span><code><span class="nt">cohort_config</span><span class="p">:</span>
  <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">select e.entity_id</span>
    <span class="no">from semantic.entities as e</span>
    <span class="no">where</span>
    <span class="no">daterange(start_time, end_time, '[]') @&gt; '{as_of_date}'::date</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">'active_facilities'</span>
</code></pre></div>
<p><code>Triage</code> will generate the features for us, but we need to tell it
which features we want in the section <code>feature_aggregations</code>. Here,
each entry describes a <code>collate.SpacetimeAggregation</code> object and the
arguments needed to create it<sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup>. For this experiment, we will use only
one feature (number of inspections). <code>DummyClassifier</code> don't use any
feature to do the "prediction", so we won't expend compute cycles
doing the feature/matrix creation:</p>
<div class="highlight"><pre><span></span><code><span class="nt">feature_aggregations</span><span class="p">:</span>
  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">'inspections'</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">'semantic.events'</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">'date'</span>

    <span class="nt">aggregates_imputation</span><span class="p">:</span>
      <span class="nt">count</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">'zero_noflag'</span>

    <span class="nt">aggregates</span><span class="p">:</span>
       <span class="p p-Indicator">-</span>
        <span class="nt">quantity</span><span class="p">:</span>
          <span class="nt">total</span><span class="p">:</span> <span class="s">"*"</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">'count'</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'all'</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">'entity_id'</span>

<span class="nt">feature_group_definition</span><span class="p">:</span>
   <span class="nt">prefix</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">'inspections'</span>

<span class="nt">feature_group_strategies</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'all'</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>If we observe the image generated from the <code>temporal_config</code> section,
each particular date is the beginning of the rectangles that describes
the rows in the matrix. In that date (<code>as_of_date</code> in <code>timechop</code>
parlance) we will calculate the feature, and we will repeat that for
every other rectangle in that image.</p>
<p>Now, let's discuss how we will specify the models to try (remember
that the model is specified by the algorithm, the hyperparameters, and
the subset of features to use). In <code>triage</code> you need to specify in the
<code>grid_config</code> section a list of machine learning algorithms that you
want to train and a list of hyperparameters. You can use any algorithm
that you want; the only requirement is that it respects the <code>sklearn</code>
API.</p>
<div class="highlight"><pre><span></span><code><span class="nt">grid_config</span><span class="p">:</span>
    <span class="s">'sklearn.dummy.DummyClassifier'</span><span class="p p-Indicator">:</span>
        <span class="nt">strategy</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">uniform</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>Finally, we should define wich metrics we care about for evaluating
our model. Here we will concentrate only in <code>precision</code> and <code>recall</code>
at an specific value <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> <sup id="fnref:6"><a class="footnote-ref" href="#fn:6">6</a></sup>.</p>
<p>In this setting <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> represents the resource’s constraint: It is the
number of inspections that the city could do in a month given all the
inspectors available.</p>
<div class="highlight"><pre><span></span><code><span class="nt">scoring</span><span class="p">:</span>
    <span class="nt">testing_metric_groups</span><span class="p">:</span>
        <span class="p p-Indicator">-</span>
          <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">,</span> <span class="s">'false</span><span class="nv"> </span><span class="s">negatives@'</span><span class="p p-Indicator">,</span> <span class="s">'false</span><span class="nv"> </span><span class="s">positives@'</span><span class="p p-Indicator">,</span> <span class="s">'true</span><span class="nv"> </span><span class="s">positives@'</span><span class="p p-Indicator">,</span> <span class="s">'true</span><span class="nv"> </span><span class="s">negatives@'</span><span class="p p-Indicator">]</span>
          <span class="nt">thresholds</span><span class="p">:</span>
            <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
            <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>
        <span class="p p-Indicator">-</span>
          <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">auc</span><span class="p p-Indicator">,</span> <span class="nv">accuracy</span><span class="p p-Indicator">]</span>

    <span class="nt">training_metric_groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">auc</span><span class="p p-Indicator">,</span> <span class="nv">accuracy</span><span class="p p-Indicator">]</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">]</span>
        <span class="nt">thresholds</span><span class="p">:</span>
          <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
          <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>You should be warned that precision and recall at <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> in this
setting is kind of ill-defined (because you will end with a lot of
<code>NULL</code> labels, remember, only a few of facilities are inspected in
each period)<sup id="fnref:7"><a class="footnote-ref" href="#fn:7">7</a></sup>.</p>
<p>We will want a <strong>list</strong> of facilities to be inspected. The length of
our list is constrained by our inspection resources, i.e. the answer
to the question <em>How many facilities can I inspect in a month?</em> In
this experiment we are assuming that the maximum capacity is <strong>10%</strong>
but we are evaluating for a larger space of possibilities (see
<code>top_n</code>, <code>percentiles</code> above).</p>
<p>The execution of the experiments can take a long time, so it is a good
practice to <em>validate</em> the configuration file <em>before</em> running the
model. You don't want to wait for hours (or days) and then discover
that something went wrong.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_baseline.yaml  --validate-only
</code></pre></div>
<p>If everything was ok, you should see an <code>Experiment validation ran to completion with no errors</code>.</p>
<p>You can execute the experiment as<sup id="fnref:8"><a class="footnote-ref" href="#fn:8">8</a></sup></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
<span class="nb">time</span> triage experiment experiments/inspections_baseline.yaml
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Protip</p>
<p>We are including the command <code>time</code> in order to get the total
running time of the experiment. You can remove it, if you like.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Don’t be scared!</p>
<p>This will print a lot of output! It is not an error!</p>
</div>
<p>We can query the table <code>experiments</code> to see the quantity of work that
<code>triage</code> needs to do</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">experiment_hash</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">experiment</span><span class="p">,</span>
    <span class="n">config</span> <span class="o">-&gt;</span> <span class="s1">'user_metadata'</span> <span class="o">-&gt;&gt;</span> <span class="s1">'description'</span>  <span class="k">as</span> <span class="n">description</span><span class="p">,</span>
    <span class="n">total_features</span><span class="p">,</span>
    <span class="n">matrices_needed</span><span class="p">,</span>
    <span class="n">models_needed</span>
<span class="k">from</span> <span class="n">triage_metadata</span><span class="p">.</span><span class="n">experiments</span><span class="p">;</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>experiment</th>
<th>description</th>
<th>total_features</th>
<th>matrices_needed</th>
<th>models_needed</th>
</tr>
</thead>
<tbody>
<tr>
<td>e912</td>
<td>"Baseline calculation\n"</td>
<td>1</td>
<td>10</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>If everything is correct, <code>triage</code>  will
create <strong>10</strong> matrices (5 for training, 5 for testing) in
<code>triage/matrices</code> and every matrix will be represented by two files,
one with the metadata of the matrix (a <code>yaml</code> file) and one with the
actual matrix (the <code>gz</code> file).</p>
<div class="highlight"><pre><span></span><code><span class="c1"># We will use some bash magic</span>

ls matrices <span class="p">|</span> awk -F . <span class="s1">'{print $NF}'</span> <span class="p">|</span> sort <span class="p">|</span> uniq -c
</code></pre></div>
<p><code>Triage</code> also will store <strong>5</strong> trained models in <code>triage/trained_models</code>:</p>
<div class="highlight"><pre><span></span><code>ls trained_models <span class="p">|</span> wc -l
</code></pre></div>
<p>And it will populate the <code>results</code> schema in the database. As
mentioned, we will get <strong>1</strong> <em>model groups</em>:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">model_groups</span>
<span class="k">where</span>
    <span class="n">model_config</span> <span class="o">-&gt;&gt;</span> <span class="s1">'experiment_type'</span> <span class="o">~</span> <span class="s1">'inspection'</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_group_id</th>
<th>model_type</th>
<th>hyperparameters</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "prior"}</td>
</tr>
</tbody>
</table>
<p>And <strong>5</strong> <em>models</em>:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">train_end_time</span><span class="p">::</span><span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="n">train_end_times</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">models</span>
<span class="k">where</span>
    <span class="n">model_comment</span> <span class="o">~</span> <span class="s1">'inspection'</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">;</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_group_id</th>
<th>models</th>
<th>train_end_times</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>{1,2,3,4,5}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
</tr>
</tbody>
</table>
<p>From that last query, you should note that the order in which <code>triage</code>
trains the models is from oldest to newest <code>train_end_time</code> and
<code>model_group</code> , also in ascending order. It will not go to the next
block until all the <em>models groups</em> are trained.</p>
<p>You can check on which matrix each models were trained:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_id</span><span class="p">,</span> <span class="n">train_end_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">model_hash</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">model_hash</span><span class="p">,</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">train_matrix_uuid</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">train_matrix_uuid</span><span class="p">,</span>
    <span class="n">ma</span><span class="p">.</span><span class="n">num_observations</span> <span class="k">as</span> <span class="n">observations</span><span class="p">,</span>
    <span class="n">ma</span><span class="p">.</span><span class="n">lookback_duration</span> <span class="k">as</span> <span class="n">feature_lookback_duration</span><span class="p">,</span>  <span class="n">ma</span><span class="p">.</span><span class="n">feature_start_time</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">models</span> <span class="k">as</span> <span class="n">mo</span>
    <span class="k">join</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">matrices</span> <span class="k">as</span> <span class="n">ma</span>
    <span class="k">on</span> <span class="n">train_matrix_uuid</span> <span class="o">=</span> <span class="n">matrix_uuid</span>
<span class="k">where</span>
    <span class="n">mo</span><span class="p">.</span><span class="n">model_comment</span> <span class="o">~</span> <span class="s1">'inspection'</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">;</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_group_id</th>
<th>model_id</th>
<th>train_end_time</th>
<th>model_hash</th>
<th>train_matrix_uuid</th>
<th>observations</th>
<th>feature_lookback_duration</th>
<th>feature_start_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>2015-12-01</td>
<td>743a6</td>
<td>1c266</td>
<td>5790</td>
<td>5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>2016-06-01</td>
<td>5b656</td>
<td>755c6</td>
<td>11502</td>
<td>5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>2016-12-01</td>
<td>5c170</td>
<td>2aea8</td>
<td>17832</td>
<td>5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>2017-06-01</td>
<td>55c3e</td>
<td>3efdc</td>
<td>23503</td>
<td>5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
<tr>
<td>1</td>
<td>5</td>
<td>2017-12-01</td>
<td>ac993</td>
<td>a3762</td>
<td>29112</td>
<td>5 years</td>
<td>2010-01-04 00:00:00</td>
</tr>
</tbody>
</table>
<p>Each model was
trained with the matrix indicated in the column
<code>train_matrix_uuid</code>. This <code>uuid</code> is the file name of the stored
matrix. The model itself was stored under the file named with the
<code>model_hash</code>.</p>
<p>If you want to see in which matrix the model was <em>tested</em> you need to run the following query</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span> <span class="k">distinct</span>
    <span class="n">model_id</span><span class="p">,</span>
    <span class="n">model_group_id</span><span class="p">,</span> <span class="n">train_end_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">model_hash</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">model_hash</span><span class="p">,</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">matrix_uuid</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">test_matrix_uuid</span><span class="p">,</span>
    <span class="n">ma</span><span class="p">.</span><span class="n">num_observations</span> <span class="k">as</span> <span class="n">observations</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">models</span> <span class="k">as</span> <span class="n">mo</span>
    <span class="k">join</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span> <span class="k">as</span> <span class="n">ev</span> <span class="k">using</span> <span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
    <span class="k">join</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">matrices</span> <span class="k">as</span> <span class="n">ma</span> <span class="k">on</span> <span class="n">ev</span><span class="p">.</span><span class="n">matrix_uuid</span> <span class="o">=</span> <span class="n">ma</span><span class="p">.</span><span class="n">matrix_uuid</span>
<span class="k">where</span>
    <span class="n">mo</span><span class="p">.</span><span class="n">model_comment</span> <span class="o">~</span> <span class="s1">'inspection'</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">,</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">;</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_id</th>
<th>model_group_id</th>
<th>train_end_time</th>
<th>model_hash</th>
<th>test_matrix_uuid</th>
<th>observations</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>2015-12-01</td>
<td>743a6</td>
<td>4a0ea</td>
<td>18719</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>2016-06-01</td>
<td>5b656</td>
<td>f908e</td>
<td>19117</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>2016-12-01</td>
<td>5c170</td>
<td>00a88</td>
<td>19354</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>2017-06-01</td>
<td>55c3e</td>
<td>8f3cf</td>
<td>19796</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>2017-12-01</td>
<td>ac993</td>
<td>417f0</td>
<td>20159</td>
</tr>
</tbody>
</table>
<p>All the models were stored in <code>/triage/trained_models/{model_hash}</code>
using the standard serialization of sklearn models. Every model was
trained with the matrix <code>train_matrix_uuid</code> stored in the directory
<code>/triage/matrices</code>.</p>
<p>What's the performance of this model groups?</p>
<div class="highlight"><pre><span></span><code><span class="err">\</span><span class="k">set</span> <span class="n">k</span> <span class="mi">0</span><span class="p">.</span><span class="mi">10</span>    <span class="c1">-- This defines a variable, "k = 0.10"</span>

<span class="k">select</span> <span class="k">distinct</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_id</span><span class="p">,</span>
    <span class="n">ma</span><span class="p">.</span><span class="n">feature_start_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">train_end_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_end_time</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ma</span><span class="p">.</span><span class="n">num_observations</span><span class="p">,</span> <span class="s1">'999,999'</span><span class="p">)</span> <span class="k">as</span> <span class="n">observations</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_examples</span><span class="p">,</span> <span class="s1">'999,999'</span><span class="p">)</span> <span class="k">as</span> <span class="ss">"total labeled examples"</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_positive_labels</span><span class="p">,</span> <span class="s1">'999,999'</span><span class="p">)</span> <span class="k">as</span> <span class="ss">"total positive labels"</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_above_threshold</span><span class="p">,</span> <span class="s1">'999,999'</span><span class="p">)</span> <span class="k">as</span> <span class="ss">"labeled examples@k%"</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(:</span><span class="n">k</span> <span class="o">*</span> <span class="n">ma</span><span class="p">.</span><span class="n">num_observations</span><span class="p">,</span> <span class="s1">'999,999'</span><span class="p">)</span> <span class="k">as</span> <span class="ss">"predicted positive (PP)"</span><span class="p">,</span>
    <span class="nb">ARRAY</span><span class="p">[</span><span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">best_value</span> <span class="o">*</span> <span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_above_threshold</span><span class="p">,</span><span class="s1">'999,999'</span><span class="p">),</span>
          <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">worst_value</span> <span class="o">*</span> <span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_above_threshold</span><span class="p">,</span><span class="s1">'999,999'</span><span class="p">),</span>
          <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">stochastic_value</span> <span class="o">*</span> <span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_above_threshold</span><span class="p">,</span> <span class="s1">'999,999'</span><span class="p">)]</span>
    <span class="k">as</span> <span class="ss">"true positive (TP)@k% (best,worst,stochastic)"</span><span class="p">,</span>
    <span class="nb">ARRAY</span><span class="p">[</span> <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">best_value</span><span class="p">,</span> <span class="s1">'0.999'</span><span class="p">),</span> <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">worst_value</span><span class="p">,</span> <span class="s1">'0.999'</span><span class="p">),</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">stochastic_value</span><span class="p">,</span> <span class="s1">'0.999'</span><span class="p">)]</span>  <span class="k">as</span> <span class="ss">"precision@k% (best,worst,stochastic)"</span><span class="p">,</span>
    <span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_positive_labels</span><span class="o">*</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_examples</span><span class="p">,</span> <span class="s1">'0.999'</span><span class="p">)</span> <span class="k">as</span> <span class="n">baserate</span><span class="p">,</span>
    <span class="p">:</span><span class="n">k</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">as</span> <span class="ss">"k%"</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">models</span> <span class="k">as</span> <span class="n">mo</span>
    <span class="k">join</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span> <span class="k">as</span> <span class="n">ev</span> <span class="k">using</span> <span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
    <span class="k">join</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">matrices</span> <span class="k">as</span> <span class="n">ma</span> <span class="k">on</span> <span class="n">ev</span><span class="p">.</span><span class="n">matrix_uuid</span> <span class="o">=</span> <span class="n">ma</span><span class="p">.</span><span class="n">matrix_uuid</span>
<span class="k">where</span>
    <span class="n">ev</span><span class="p">.</span><span class="n">metric</span> <span class="o">||</span> <span class="n">ev</span><span class="p">.</span><span class="k">parameter</span> <span class="o">=</span> <span class="s1">'precision@15_pct'</span>
    <span class="k">and</span>
    <span class="n">mo</span><span class="p">.</span><span class="n">model_comment</span> <span class="o">~</span> <span class="s1">'inspection'</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_id</span><span class="p">,</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">;</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_id</span><span class="p">,</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">;</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_group_id</th>
<th>model_id</th>
<th>feature_start_time</th>
<th>train_end_time</th>
<th>evaluation_start_time</th>
<th>evaluation_end_time</th>
<th>observations</th>
<th>total labeled examples</th>
<th>total positive labels</th>
<th>labeled examples@k%</th>
<th>predicted positive (PP)</th>
<th>true positive (TP)@k% (best,worst,stochastic)</th>
<th>precision@k% (best,worst,stochastic)</th>
<th>baserate</th>
<th>k%</th>
</tr>
</thead>
<tbody>
<tr>
<td>21</td>
<td>121</td>
<td>2010-01-04</td>
<td>2015-12-01</td>
<td>2015-12-01</td>
<td>2015-12-01</td>
<td>18,719</td>
<td>5,712</td>
<td>1,509</td>
<td>0</td>
<td>2,808</td>
<td>{"       0","       0","       0"}</td>
<td>{" 0.000"," 0.000"," 0.000"}</td>
<td>0.264</td>
<td>15.00</td>
</tr>
<tr>
<td>21</td>
<td>122</td>
<td>2010-01-04</td>
<td>2016-06-01</td>
<td>2016-06-01</td>
<td>2016-06-01</td>
<td>19,117</td>
<td>6,330</td>
<td>1,742</td>
<td>0</td>
<td>2,868</td>
<td>{"       0","       0","       0"}</td>
<td>{" 0.000"," 0.000"," 0.000"}</td>
<td>0.275</td>
<td>15.00</td>
</tr>
<tr>
<td>21</td>
<td>123</td>
<td>2010-01-04</td>
<td>2016-12-01</td>
<td>2016-12-01</td>
<td>2016-12-01</td>
<td>19,354</td>
<td>5,671</td>
<td>1,494</td>
<td>0</td>
<td>2,903</td>
<td>{"       0","       0","       0"}</td>
<td>{" 0.000"," 0.000"," 0.000"}</td>
<td>0.263</td>
<td>15.00</td>
</tr>
<tr>
<td>21</td>
<td>124</td>
<td>2010-01-04</td>
<td>2017-06-01</td>
<td>2017-06-01</td>
<td>2017-06-01</td>
<td>19,796</td>
<td>5,609</td>
<td>1,474</td>
<td>0</td>
<td>2,969</td>
<td>{"       0","       0","       0"}</td>
<td>{" 0.000"," 0.000"," 0.000"}</td>
<td>0.263</td>
<td>15.00</td>
</tr>
<tr>
<td>21</td>
<td>125</td>
<td>2010-01-04</td>
<td>2017-12-01</td>
<td>2017-12-01</td>
<td>2017-12-01</td>
<td>20,159</td>
<td>4,729</td>
<td>1,260</td>
<td>0</td>
<td>3,024</td>
<td>{"       0","       0","       0"}</td>
<td>{" 0.000"," 0.000"," 0.000"}</td>
<td>0.266</td>
<td>15.00</td>
</tr>
</tbody>
</table>
<p>The columns <code>num_labeled_examples, num_labeled_above_threshold,
num_positive_labels</code> represent the number of selected entities on the
prediction date that are labeled, the number of entities with a
positive label above the threshold, and the number of entities with
positive labels among all the labeled entities respectively.</p>
<p>We added some extra columns: <code>baserate</code>, <code>predicted positive (PP)</code>
and <code>true positive (TP)</code>. <em>Baserate</em> represents the proportion of the
all the facilities that were inspected that failed the inspection,
i.e. <span><span class="MathJax_Preview">P(V|I)</span><script type="math/tex">P(V|I)</script></span>. The <code>PP</code> and <code>TP</code> are approximate since it were
calculated using the value of <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> or the precision value. But you could get the exact value
of those from the <code>test_results.predictions</code> table.</p>
<p>Also note that in the <code>precision@k%</code> column we are showing three
numbers: <strong>best</strong>, <strong>worst</strong>, <strong>stochastic</strong>.</p>
<p>They try to answer the question <em>How do you break ties in the
prediction score?</em> This is important because it will affect the
calculation of your metrics. The <code>Triage</code> proposed solution to this is calculate the metric in the <em>best case
scenario</em> (score descending, all the true labels are at the top), and then do it in the <em>worst
case scenario</em> (score descending, all the true labels are at the
bottom) and then
calculate the metric several times (<span><span class="MathJax_Preview">n=30</span><script type="math/tex">n=30</script></span>) with the labels randomly shuffled
(a.k.a. <em>stochastic scenario</em>), so you
get the mean metric, plus some confidence intervals.</p>
<p>This problem is not specific of an inspection problem, is more related to
simple models like a shallow <code>Decision Tree</code> or a <code>Dummy Classifier</code>
when score ties likely will occur.</p>
<p>Note how in this model, the stochastic value is close to the
<em>baserate</em>, since we are selecting at random using the <em>prior</em>.</p>
<div class="admonition info">
<p class="admonition-title">Check this!</p>
<p>Note that the <em>baserate</em> should be equal to the <em>precision@100%</em>, if is not there is something wrong …</p>
</div>
<h3 id="creating-a-simple-experiment">Creating a simple experiment<a class="headerlink" href="#creating-a-simple-experiment" title="Permanent link">#</a></h3>
<p>We will try two of the simplest machine learning algorithms: a
<strong>Decision Tree Classifier</strong> (<em>DT</em>) and a  <strong>Scaled Logistic
Regression</strong> (<em>SLR</em>)<sup id="fnref:12"><a class="footnote-ref" href="#fn:12">12</a></sup> as a second experiment. The
rationale of this is that the DT is very fast to train (so it will
help us to verify that the experiment configuration is correct without
waiting for a long time) and it helps you to understand the structure
of your data.</p>
<p>The config file for this first experiment is located in <code>/triage/experiments/inspections_dt.yaml</code></p>
<p>Note that we don't modify the <code>temporal_config</code> section neither the
<code>feature_aggregations</code>, <code>cohort_config</code> or <code>label_config</code>. Triage is
smart enough to use the previous tables and matrices instead of
generating them from scratch.</p>
<div class="highlight"><pre><span></span><code><span class="nt">config_version</span><span class="p">:</span> <span class="s">'v7'</span>

<span class="nt">model_comment</span><span class="p">:</span> <span class="s">'inspections:</span><span class="nv"> </span><span class="s">basic</span><span class="nv"> </span><span class="s">ML'</span>

<span class="nt">user_metadata</span><span class="p">:</span>
  <span class="nt">label_definition</span><span class="p">:</span> <span class="s">'failed'</span>
  <span class="nt">experiment_type</span><span class="p">:</span> <span class="s">'inspections</span><span class="nv"> </span><span class="s">prioritization'</span>
  <span class="nt">file_name</span><span class="p">:</span> <span class="s">'inspections_dt.yaml'</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">DT and SLR</span>
  <span class="nt">purpose</span><span class="p">:</span> <span class="s">'data</span><span class="nv"> </span><span class="s">mining'</span>
  <span class="nt">org</span><span class="p">:</span> <span class="s">'DSaPP'</span>
  <span class="nt">team</span><span class="p">:</span> <span class="s">'Tutorial'</span>
  <span class="nt">author</span><span class="p">:</span> <span class="s">'Your</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">here'</span>
  <span class="nt">etl_date</span><span class="p">:</span> <span class="s">'2019-02-21'</span>
</code></pre></div>
<p>Note that we don't modify the <code>temporal_config</code> section neither the
<code>cohort_config</code> or <code>label_config</code>. Triage is smart enough to use the
previous tables and matrices instead of generating them from scratch.</p>
<p>For this experiment, we will add the following features:</p>
<ul>
<li>
<p>Number of different types of inspections the facility had in the last year (calculated for an <em>as-of-date</em>).</p>
</li>
<li>
<p>Number of different types of inspections that happened in the zip code in the last year from a particular day.</p>
</li>
<li>
<p>Number of inspections</p>
</li>
<li>
<p>Number/proportion of inspections by result type</p>
</li>
<li>
<p>Number/proportion of times that a facility was classify with particular risk level</p>
</li>
</ul>
<p>In all of them we will do the aggregation in the last month, 3 months,
6 months, 1 year and historically. Remember that all this refers to
events in the past, i.e. <em>How many times the facility was marked with
high risk in the previous 3 Months?</em>, <em>What is the proportion of
failed inspections in the previous year?</em></p>
<div class="highlight"><pre><span></span><code><span class="nt">feature_aggregations</span><span class="p">:</span>
  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">'inspections'</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">'semantic.events'</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">'date'</span>

    <span class="nt">aggregates_imputation</span><span class="p">:</span>
      <span class="nt">count</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">'zero_noflag'</span>

    <span class="nt">aggregates</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">quantity</span><span class="p">:</span>
          <span class="nt">total</span><span class="p">:</span> <span class="s">"*"</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">'count'</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'1month'</span><span class="p p-Indicator">,</span> <span class="s">'3month'</span><span class="p p-Indicator">,</span> <span class="s">'6month'</span><span class="p p-Indicator">,</span> <span class="s">'1y'</span><span class="p p-Indicator">,</span> <span class="s">'all'</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">'entity_id'</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">'risks'</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">'semantic.events'</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">'date'</span>

    <span class="nt">categoricals_imputation</span><span class="p">:</span>
      <span class="nt">sum</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">'zero'</span>
      <span class="nt">avg</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">'zero'</span>

    <span class="nt">categoricals</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">column</span><span class="p">:</span> <span class="s">'risk'</span>
        <span class="nt">choices</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'low'</span><span class="p p-Indicator">,</span> <span class="s">'medium'</span><span class="p p-Indicator">,</span> <span class="s">'high'</span><span class="p p-Indicator">]</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">'sum'</span>
          <span class="p p-Indicator">-</span> <span class="s">'avg'</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'1month'</span><span class="p p-Indicator">,</span> <span class="s">'3month'</span><span class="p p-Indicator">,</span> <span class="s">'6month'</span><span class="p p-Indicator">,</span> <span class="s">'1y'</span><span class="p p-Indicator">,</span> <span class="s">'all'</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">'entity_id'</span>
      <span class="p p-Indicator">-</span> <span class="s">'zip_code'</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">'results'</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">'semantic.events'</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">'date'</span>

    <span class="nt">categoricals_imputation</span><span class="p">:</span>
      <span class="nt">all</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">'zero'</span>

    <span class="nt">categoricals</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">column</span><span class="p">:</span> <span class="s">'result'</span>
        <span class="nt">choice_query</span><span class="p">:</span> <span class="s">'select</span><span class="nv"> </span><span class="s">distinct</span><span class="nv"> </span><span class="s">result</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">semantic.events'</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">'sum'</span>
          <span class="p p-Indicator">-</span> <span class="s">'avg'</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'1month'</span><span class="p p-Indicator">,</span> <span class="s">'3month'</span><span class="p p-Indicator">,</span> <span class="s">'6month'</span><span class="p p-Indicator">,</span> <span class="s">'1y'</span><span class="p p-Indicator">,</span> <span class="s">'all'</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">'entity_id'</span>

  <span class="p p-Indicator">-</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">'inspection_types'</span>
    <span class="nt">from_obj</span><span class="p">:</span> <span class="s">'semantic.events'</span>
    <span class="nt">knowledge_date_column</span><span class="p">:</span> <span class="s">'date'</span>

    <span class="nt">categoricals_imputation</span><span class="p">:</span>
      <span class="nt">sum</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">'zero_noflag'</span>

    <span class="nt">categoricals</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">column</span><span class="p">:</span> <span class="s">'type'</span>
        <span class="nt">choice_query</span><span class="p">:</span> <span class="s">'select</span><span class="nv"> </span><span class="s">distinct</span><span class="nv"> </span><span class="s">type</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">semantic.events</span><span class="nv"> </span><span class="s">where</span><span class="nv"> </span><span class="s">type</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">null'</span>
        <span class="nt">metrics</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">'sum'</span>

    <span class="nt">intervals</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'1month'</span><span class="p p-Indicator">,</span> <span class="s">'3month'</span><span class="p p-Indicator">,</span> <span class="s">'6month'</span><span class="p p-Indicator">,</span> <span class="s">'1y'</span><span class="p p-Indicator">,</span> <span class="s">'all'</span><span class="p p-Indicator">]</span>

    <span class="nt">groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">'entity_id'</span>
      <span class="p p-Indicator">-</span> <span class="s">'zip_code'</span>
</code></pre></div>
<p>And as stated, we will train some Decision Trees, in particular we are
interested in some shallow trees, and in a full grown tree. These trees
will show you the structure of your data. We also will train some Scaled
Logistic Regression, this will show us how "linear" is the data (or how
the assumptions of the Logistic Regression holds in this data)</p>
<div class="highlight"><pre><span></span><code><span class="nt">grid_config</span><span class="p">:</span>
  <span class="s">'sklearn.tree.DecisionTreeClassifier'</span><span class="p p-Indicator">:</span>
        <span class="nt">criterion</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'gini'</span><span class="p p-Indicator">]</span>
        <span class="nt">max_features</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'sqrt'</span><span class="p p-Indicator">]</span>
        <span class="nt">max_depth</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">2</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span><span class="nv">~</span><span class="p p-Indicator">]</span>
        <span class="nt">min_samples_split</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nv">10</span><span class="p p-Indicator">,</span><span class="nv">50</span><span class="p p-Indicator">]</span>

  <span class="s">'triage.component.catwalk.estimators.classifiers.ScaledLogisticRegression'</span><span class="p p-Indicator">:</span>
        <span class="nt">penalty</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'l1'</span><span class="p p-Indicator">,</span><span class="s">'l2'</span><span class="p p-Indicator">]</span>
        <span class="nt">C</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0.000001</span><span class="p p-Indicator">,</span> <span class="nv">0.0001</span><span class="p p-Indicator">,</span> <span class="nv">0.01</span><span class="p p-Indicator">,</span>  <span class="nv">1.0</span><span class="p p-Indicator">]</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">About <code>yaml</code> and <code>sklearn</code></p>
<p>Some of the parameters in <code>sklearn</code> are <code>None</code>. If you want to try
those you need to indicate it with <code>yaml</code>'s <code>null</code> or <code>~</code> keyword.</p>
</div>
<p>Besides the algorithm and the hyperparameters, you should specify
which subset of features use. First, in the section
<code>feature_group_definition</code> you specify how to group the features (you
can use the <code>table name</code> or the <code>prefix</code> from the section
<code>feature_aggregation</code>) and then a <em>strategy</em> for choosing the subsets:
<code>all</code> (all the subsets at once), <code>leave-one-out</code> (try all the subsets
except one, do that for all the combinations), or <code>leave-one-in</code> (just
try subset at the time).</p>
<div class="highlight"><pre><span></span><code><span class="nt">feature_group_definition</span><span class="p">:</span>
   <span class="nt">prefix</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">'inspections'</span>
     <span class="p p-Indicator">-</span> <span class="s">'results'</span>
     <span class="p p-Indicator">-</span> <span class="s">'risks'</span>
     <span class="p p-Indicator">-</span> <span class="s">'inspection_types'</span>

<span class="nt">feature_group_strategies</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'all'</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>Finally we will leave the <code>scoring</code> section as before.</p>
<p>In this experiment we will end with <strong>6</strong> model groups (number of
algorithms [1] <span><span class="MathJax_Preview">\times</span><script type="math/tex">\times</script></span> number of hyperparameter combinations [2
<span><span class="MathJax_Preview">\times</span><script type="math/tex">\times</script></span> 3 = 5] <span><span class="MathJax_Preview">\times</span><script type="math/tex">\times</script></span> number of feature groups strategies
[1]]). Also, we will create <strong>18</strong> models (3 per model group) given
that we have 3 temporal blocks (one model per temporal group).</p>
<p>Before running the experiment, remember to validate that the configuration is correct:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_dt.yaml  --validate-only
</code></pre></div>
<p>and check the temporal cross validation:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_dt.yaml --show-timechop
</code></pre></div>
<p><img alt="img" src="../images/triage/inspections_dt.png" title="Temporal blocks for inspections experiment. The label is a failed inspection in the next month."/>
<em>Temporal blocks for inspections experiment. The label is a failed inspection in the next year.</em></p>
<p>You can execute the experiment like this:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
<span class="nb">time</span> triage experiment experiments/inspections_dt.yaml
</code></pre></div>
<p>Again, we can run the following <code>sql</code> to see which things <code>triage</code>
needs to run:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="k">substring</span><span class="p">(</span><span class="n">experiment_hash</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">experiment</span><span class="p">,</span>
    <span class="n">config</span> <span class="o">-&gt;</span> <span class="s1">'user_metadata'</span> <span class="o">-&gt;&gt;</span> <span class="s1">'description'</span>  <span class="k">as</span> <span class="n">description</span><span class="p">,</span>
    <span class="n">total_features</span><span class="p">,</span>
    <span class="n">matrices_needed</span><span class="p">,</span>
    <span class="n">models_needed</span>
<span class="k">from</span> <span class="n">triage_metadata</span><span class="p">.</span><span class="n">experiments</span><span class="p">;</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>experiment</th>
<th>description</th>
<th>total_features</th>
<th>matrices_needed</th>
<th>models_needed</th>
</tr>
</thead>
<tbody>
<tr>
<td>e912</td>
<td>Baseline calculation</td>
<td>1</td>
<td>10</td>
<td>5</td>
</tr>
<tr>
<td>b535</td>
<td>DT and SLR</td>
<td>201</td>
<td>10</td>
<td>100</td>
</tr>
</tbody>
</table>
<p>You can compare our two experiments and there are several differences,
mainly in the order of magnitude. Like the number of features (1 vs
201) and models built (5 vs 100).</p>
<p>The After the experiment finishes, you will get <strong>19</strong> new <code>model_groups</code> (1 per combination in <code>grid_config</code>)</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">model_groups</span>
<span class="k">where</span>
    <span class="n">model_group_id</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_group_id</th>
<th>model_type</th>
<th>hyperparameters</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": 1, "max_features": "sqrt", "min_samples_split": 2}</td>
</tr>
<tr>
<td>3</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": 1, "max_features": "sqrt", "min_samples_split": 10}</td>
</tr>
<tr>
<td>4</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": 1, "max_features": "sqrt", "min_samples_split": 50}</td>
</tr>
<tr>
<td>5</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": 2, "max_features": "sqrt", "min_samples_split": 2}</td>
</tr>
<tr>
<td>6</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": 2, "max_features": "sqrt", "min_samples_split": 10}</td>
</tr>
<tr>
<td>7</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": 2, "max_features": "sqrt", "min_samples_split": 50}</td>
</tr>
<tr>
<td>8</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": 5, "max_features": "sqrt", "min_samples_split": 2}</td>
</tr>
<tr>
<td>9</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": 5, "max_features": "sqrt", "min_samples_split": 10}</td>
</tr>
<tr>
<td>10</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": 5, "max_features": "sqrt", "min_samples_split": 50}</td>
</tr>
<tr>
<td>11</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": null, "max_features": "sqrt", "min_samples_split": 2}</td>
</tr>
<tr>
<td>12</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": null, "max_features": "sqrt", "min_samples_split": 10}</td>
</tr>
<tr>
<td>13</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"criterion": "gini", "max_depth": null, "max_features": "sqrt", "min_samples_split": 50}</td>
</tr>
<tr>
<td>14</td>
<td>triage.component.catwalk.estimators.classifiers.ScaledLogisticRegression</td>
<td>{"C": 0.000001, "penalty": "l1"}</td>
</tr>
<tr>
<td>15</td>
<td>triage.component.catwalk.estimators.classifiers.ScaledLogisticRegression</td>
<td>{"C": 0.000001, "penalty": "l2"}</td>
</tr>
<tr>
<td>16</td>
<td>triage.component.catwalk.estimators.classifiers.ScaledLogisticRegression</td>
<td>{"C": 0.0001, "penalty": "l1"}</td>
</tr>
<tr>
<td>17</td>
<td>triage.component.catwalk.estimators.classifiers.ScaledLogisticRegression</td>
<td>{"C": 0.0001, "penalty": "l2"}</td>
</tr>
<tr>
<td>18</td>
<td>triage.component.catwalk.estimators.classifiers.ScaledLogisticRegression</td>
<td>{"C": 0.01, "penalty": "l1"}</td>
</tr>
<tr>
<td>19</td>
<td>triage.component.catwalk.estimators.classifiers.ScaledLogisticRegression</td>
<td>{"C": 0.01, "penalty": "l2"}</td>
</tr>
<tr>
<td>20</td>
<td>triage.component.catwalk.estimators.classifiers.ScaledLogisticRegression</td>
<td>{"C": 1.0, "penalty": "l1"}</td>
</tr>
<tr>
<td>21</td>
<td>triage.component.catwalk.estimators.classifiers.ScaledLogisticRegression</td>
<td>{"C": 1.0, "penalty": "l2"}</td>
</tr>
</tbody>
</table>
<p>and <strong>100</strong> models (as stated before)</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">train_end_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">train_end_times</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">models</span>
<span class="k">where</span>
    <span class="n">model_group_id</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">;</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_group_id</th>
<th>models</th>
<th>train_end_times</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>{6,26,46,66,86}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>3</td>
<td>{7,27,47,67,87}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>4</td>
<td>{8,28,48,68,88}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>5</td>
<td>{9,29,49,69,89}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>6</td>
<td>{10,30,50,70,90}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>7</td>
<td>{11,31,51,71,91}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>8</td>
<td>{12,32,52,72,92}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>9</td>
<td>{13,33,53,73,93}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>10</td>
<td>{14,34,54,74,94}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>11</td>
<td>{15,35,55,75,95}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>12</td>
<td>{16,36,56,76,96}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>13</td>
<td>{17,37,57,77,97}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>14</td>
<td>{18,38,58,78,98}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>15</td>
<td>{19,39,59,79,99}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>16</td>
<td>{20,40,60,80,100}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>17</td>
<td>{21,41,61,81,101}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>18</td>
<td>{22,42,62,82,102}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>19</td>
<td>{23,43,63,83,103}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>20</td>
<td>{24,44,64,84,104}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
<tr>
<td>21</td>
<td>{25,45,65,85,105}</td>
<td>{"2015-12-01 00:00:00","2016-06-01 00:00:00","2016-12-01 00:00:00","2017-06-01 00:00:00","2017-12-01 00:00:00"}</td>
</tr>
</tbody>
</table>
<p>Let's see the performance over time of the models so far:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span><span class="p">::</span><span class="nb">date</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">evaluation_start_time</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">evaluation_end_time</span><span class="p">::</span><span class="nb">date</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">evaluation_end_time</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_examples</span><span class="p">,</span> <span class="s1">'999,999'</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">labeled_examples</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_labeled_above_threshold</span><span class="p">,</span> <span class="s1">'999,999'</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">labeled_above_threshold</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">num_positive_labels</span><span class="p">,</span> <span class="s1">'999,999'</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_positive_labels</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">ev</span><span class="p">.</span><span class="n">stochastic_value</span><span class="p">,</span> <span class="s1">'0.999'</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">ev</span><span class="p">.</span><span class="n">evaluation_start_time</span> <span class="k">asc</span><span class="p">)</span> <span class="k">as</span> <span class="ss">"precision@15%"</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">models</span> <span class="k">as</span> <span class="n">mo</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">model_groups</span> <span class="k">as</span> <span class="n">mg</span> <span class="k">using</span><span class="p">(</span><span class="n">model_group_id</span><span class="p">)</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span>  <span class="k">as</span> <span class="n">ev</span> <span class="k">using</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<span class="k">where</span>
     <span class="n">mg</span><span class="p">.</span><span class="n">model_config</span> <span class="o">-&gt;&gt;</span> <span class="s1">'experiment_type'</span> <span class="o">~</span> <span class="s1">'inspection'</span>
     <span class="k">and</span>
     <span class="n">ev</span><span class="p">.</span><span class="n">metric</span><span class="o">||</span><span class="n">ev</span><span class="p">.</span><span class="k">parameter</span> <span class="o">=</span> <span class="s1">'precision@15_pct'</span>
     <span class="k">and</span> <span class="n">model_group_id</span> <span class="k">between</span> <span class="mi">2</span> <span class="k">and</span> <span class="mi">21</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_group_id</th>
<th>models</th>
<th>evaluation_start_time</th>
<th>evaluation_end_time</th>
<th>labeled_examples</th>
<th>labeled_above_threshold</th>
<th>total_positive_labels</th>
<th>precision@15%</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>{1,2,3,4,5}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"       0","       0","       0","       0","       0"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.000"," 0.000"," 0.000"," 0.000"," 0.000"}</td>
</tr>
<tr>
<td>2</td>
<td>{6,26,46,66,86}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"       0","     578","     730","     574","       0"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.000"," 0.352"," 0.316"," 0.315"," 0.000"}</td>
</tr>
<tr>
<td>3</td>
<td>{7,27,47,67,87}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     161","     622","       0","     433","       0"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.283"," 0.203"," 0.000"," 0.282"," 0.000"}</td>
</tr>
<tr>
<td>4</td>
<td>{8,28,48,68,88}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     161","   1,171","       0","       0","     995"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.285"," 0.348"," 0.000"," 0.000"," 0.306"}</td>
</tr>
<tr>
<td>5</td>
<td>{9,29,49,69,89}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     726","   1,318","     362","     489","     291"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.306"," 0.360"," 0.213"," 0.294"," 0.241"}</td>
</tr>
<tr>
<td>6</td>
<td>{10,30,50,70,90}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     992","     730","       0","     176","     290"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.294"," 0.349"," 0.000"," 0.324"," 0.334"}</td>
</tr>
<tr>
<td>7</td>
<td>{11,31,51,71,91}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"   1,023","     325","     329","     176","   1,033"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.323"," 0.400"," 0.347"," 0.323"," 0.315"}</td>
</tr>
<tr>
<td>8</td>
<td>{12,32,52,72,92}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"   1,250","   1,013","     737","   1,104","     939"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.331"," 0.280"," 0.327"," 0.335"," 0.365"}</td>
</tr>
<tr>
<td>9</td>
<td>{13,33,53,73,93}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     595","     649","     547","   1,000","     841"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.281"," 0.250"," 0.309"," 0.350"," 0.356"}</td>
</tr>
<tr>
<td>10</td>
<td>{14,34,54,74,94}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"   1,012","     887","     856","     387","     851"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.345"," 0.339"," 0.342"," 0.248"," 0.327"}</td>
</tr>
<tr>
<td>11</td>
<td>{15,35,55,75,95}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"       0","       0","       0","       0","       0"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.000"," 0.000"," 0.000"," 0.000"," 0.000"}</td>
</tr>
<tr>
<td>12</td>
<td>{16,36,56,76,96}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"   1,094","   1,033","     878","     880","     842"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.278"," 0.332"," 0.285"," 0.311"," 0.299"}</td>
</tr>
<tr>
<td>13</td>
<td>{17,37,57,77,97}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     995","   1,117","     987","     623","     651"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.313"," 0.324"," 0.320"," 0.318"," 0.299"}</td>
</tr>
<tr>
<td>14</td>
<td>{18,38,58,78,98}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"       0","       0","       0","       0","       0"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.000"," 0.000"," 0.000"," 0.000"," 0.000"}</td>
</tr>
<tr>
<td>15</td>
<td>{19,39,59,79,99}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     771","     582","     845","     570","     625"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.246"," 0.227"," 0.243"," 0.244"," 0.232"}</td>
</tr>
<tr>
<td>16</td>
<td>{20,40,60,80,100}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"       0","       0","       0","       0","       0"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.000"," 0.000"," 0.000"," 0.000"," 0.000"}</td>
</tr>
<tr>
<td>17</td>
<td>{21,41,61,81,101}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     783","     587","     813","     586","     570"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.250"," 0.235"," 0.253"," 0.259"," 0.253"}</td>
</tr>
<tr>
<td>18</td>
<td>{22,42,62,82,102}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     551","     649","     588","     552","     444"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.310"," 0.336"," 0.355"," 0.330"," 0.372"}</td>
</tr>
<tr>
<td>19</td>
<td>{23,43,63,83,103}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"   1,007","     776","     818","     784","     725"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.343"," 0.409"," 0.373"," 0.366"," 0.421"}</td>
</tr>
<tr>
<td>20</td>
<td>{24,44,64,84,104}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     797","     971","     887","     770","     745"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.311"," 0.355"," 0.347"," 0.395"," 0.431"}</td>
</tr>
<tr>
<td>21</td>
<td>{25,45,65,85,105}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{2015-12-01,2016-06-01,2016-12-01,2017-06-01,2017-12-01}</td>
<td>{"   5,712","   6,330","   5,671","   5,609","   4,729"}</td>
<td>{"     943","     953","     837","     730","     699"}</td>
<td>{"   1,509","   1,742","   1,494","   1,474","   1,260"}</td>
<td>{" 0.320"," 0.363"," 0.349"," 0.397"," 0.429"}</td>
</tr>
</tbody>
</table>
<p>Which model in production (<em>model selection</em>) is something that we
will review later, with <code>Audition</code>, but for now, let's choose the
model group <code>3</code> and see the <code>predictions</code> table:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="n">model_id</span><span class="p">,</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="n">as_of_date</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">round</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">label_value</span> <span class="k">as</span> <span class="n">label</span>
<span class="k">from</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">predictions</span>
<span class="k">where</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="mi">11</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">as_of_date</span> <span class="k">asc</span><span class="p">,</span> <span class="n">score</span> <span class="k">desc</span>
<span class="k">limit</span> <span class="mi">20</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_id</th>
<th>entity_id</th>
<th>as_of_date</th>
<th>round</th>
<th>label</th>
</tr>
</thead>
<tbody>
<tr>
<td>11</td>
<td>26873</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>26186</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>25885</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>24831</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>24688</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>21485</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>20644</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>20528</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>19531</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>18279</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>17853</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>17642</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>16360</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>15899</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>15764</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>15381</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>15303</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>14296</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>14016</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>27627</td>
<td>2015-06-01</td>
<td>0.49</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>NOTE:</strong> Given that this is a <em>shallow</em> tree, there will be a lot of
entities with the same <em>score</em>,you probably will get a different set
of entities, since <code>postgresql</code> will sort them at random.</p>
<div class="admonition info">
<p class="admonition-title">It is important to know…</p>
<p><code>Triage</code> sorted the predictions at <em>random</em> using the
<code>random_seed</code> from the experiment’s config file. If you want the
predictions being sorted in a different way add</p>
<div class="codehilite"><pre><span></span><code>prediction:
    randk_tiebreaker: "worst" # or "best" or "random"
</code></pre></div>
</div>
<p>Note that at the top of the list (sorted by <code>as_of_date</code>, and then by
<code>score</code>), the <em>labels</em> are <code>NULL</code>. This means that the facilities that
you are classifying as high risk, actually weren't inspected in that
<em>as of date</em>. So, you actually don't know if this is a correct
prediction or not.</p>
<p>This is a <strong>characteristic</strong> of all the resource optimization
problems: You do not have all the information about the elements in
your system<sup id="fnref:9"><a class="footnote-ref" href="#fn:9">9</a></sup>.</p>
<p>So, how the precision/recall is calculated? The number that is show in
the <code>evaluations</code> table is calculated using only the rows that have a
non-null label. You could argue that this is fine, if you assume that
the distribution of the label in the non-observed facilities is the
same that the ones that were inspected that month<sup id="fnref:10"><a class="footnote-ref" href="#fn:10">10</a></sup>. We will come
back to this problem in the Early Warning Systems.</p>
<h3 id="a-more-advanced-experiment">A more advanced experiment<a class="headerlink" href="#a-more-advanced-experiment" title="Permanent link">#</a></h3>
<p>Ok, let's add a more complete experiment. First the usual generalities.</p>
<div class="highlight"><pre><span></span><code><span class="nt">config_version</span><span class="p">:</span> <span class="s">'v7'</span>

<span class="nt">model_comment</span><span class="p">:</span> <span class="s">'inspections:</span><span class="nv"> </span><span class="s">advanced'</span>

<span class="nt">user_metadata</span><span class="p">:</span>
  <span class="nt">label_definition</span><span class="p">:</span> <span class="s">'failed'</span>
  <span class="nt">experiment_type</span><span class="p">:</span> <span class="s">'inspections</span><span class="nv"> </span><span class="s">prioritization'</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">Using Ensamble methods</span>
  <span class="nt">purpose</span><span class="p">:</span> <span class="s">'trying</span><span class="nv"> </span><span class="s">ensamble</span><span class="nv"> </span><span class="s">algorithms'</span>
  <span class="nt">org</span><span class="p">:</span> <span class="s">'DSaPP'</span>
  <span class="nt">team</span><span class="p">:</span> <span class="s">'Tutorial'</span>
  <span class="nt">author</span><span class="p">:</span> <span class="s">'Your</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">here'</span>
  <span class="nt">etl_date</span><span class="p">:</span> <span class="s">'2019-02-21'</span>
</code></pre></div>
<p>We won't change anything related to features, cohort and label definition neither to temporal configuration.</p>
<p>As before, we can check the temporal structure of our crossvalidation:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_label_failed_01.yaml --show-timechop
</code></pre></div>
<p><img alt="img" src="../images/triage/inspections_label_failed_01.png" title="Temporal blocks for inspections experiment. The label is a failed inspection in the next month."/>
<em>Figure. Temporal blocks
for inspections experiment. The label is a failed inspection in the
next month.</em></p>
<p>We want to use all the features groups
(<code>feature_group_definition</code>). The training will be made on matrices
with <code>all</code> the feature groups, then leaving one feature group out at a
time, <code>leave-one-out</code> (i.e. one model with <code>inspections</code> and
<code>results</code>, another with <code>inspections</code> and <code>risks</code>, and another with
<code>results</code> and <code>risks), and finally leaving one feature group in at a
time (i.e. a model with</code>inspections<code>only, another with</code>results<code>only, and a third with</code>risks` only).</p>
<div class="highlight"><pre><span></span><code><span class="nt">feature_group_definition</span><span class="p">:</span>
   <span class="nt">prefix</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">'inspections'</span>
     <span class="p p-Indicator">-</span> <span class="s">'results'</span>
     <span class="p p-Indicator">-</span> <span class="s">'risks'</span>
     <span class="p p-Indicator">-</span> <span class="s">'inspection_types'</span>

<span class="nt">feature_group_strategies</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'all'</span><span class="p p-Indicator">,</span> <span class="s">'leave-one-in'</span><span class="p p-Indicator">,</span> <span class="s">'leave-one-out'</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>Finally, we will try some <code>RandomForestClassifier</code>:</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">grid_config</span><span class="p">:</span>
   <span class="s">'sklearn.ensemble.RandomForestClassifier'</span><span class="p p-Indicator">:</span>
     <span class="nt">n_estimators</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">10000</span><span class="p p-Indicator">]</span>
     <span class="nt">criterion</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'gini'</span><span class="p p-Indicator">]</span>
     <span class="nt">max_depth</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">]</span>
     <span class="nt">max_features</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'sqrt'</span><span class="p p-Indicator">]</span>
     <span class="nt">min_samples_split</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">]</span>
     <span class="nt">n_jobs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">]</span>

   <span class="s">'sklearn.ensemble.ExtraTreesClassifier'</span><span class="p p-Indicator">:</span>
     <span class="nt">n_estimators</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">10000</span><span class="p p-Indicator">]</span>
     <span class="nt">criterion</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'gini'</span><span class="p p-Indicator">]</span>
     <span class="nt">max_depth</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">]</span>
     <span class="nt">max_features</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'sqrt'</span><span class="p p-Indicator">]</span>
     <span class="nt">min_samples_split</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">]</span>
     <span class="nt">n_jobs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">]</span>

<span class="nt">scoring</span><span class="p">:</span>
    <span class="nt">testing_metric_groups</span><span class="p">:</span>
        <span class="p p-Indicator">-</span>
          <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">]</span>
          <span class="nt">thresholds</span><span class="p">:</span>
            <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
            <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>

    <span class="nt">training_metric_groups</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">accuracy</span><span class="p p-Indicator">]</span>
      <span class="p p-Indicator">-</span>
        <span class="nt">metrics</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">precision@</span><span class="p p-Indicator">,</span> <span class="nv">recall@</span><span class="p p-Indicator">]</span>
        <span class="nt">thresholds</span><span class="p">:</span>
          <span class="nt">percentiles</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span> <span class="nv">2.0</span><span class="p p-Indicator">,</span> <span class="nv">3.0</span><span class="p p-Indicator">,</span> <span class="nv">4.0</span><span class="p p-Indicator">,</span> <span class="nv">5.0</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">15</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">30</span><span class="p p-Indicator">,</span> <span class="nv">35</span><span class="p p-Indicator">,</span> <span class="nv">40</span><span class="p p-Indicator">,</span> <span class="nv">45</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="nv">60</span><span class="p p-Indicator">,</span> <span class="nv">65</span><span class="p p-Indicator">,</span> <span class="nv">70</span><span class="p p-Indicator">,</span> <span class="nv">75</span><span class="p p-Indicator">,</span> <span class="nv">80</span><span class="p p-Indicator">,</span> <span class="nv">85</span><span class="p p-Indicator">,</span> <span class="nv">90</span><span class="p p-Indicator">,</span> <span class="nv">95</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">]</span>
          <span class="nt">top_n</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">,</span> <span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">,</span> <span class="nv">500</span><span class="p p-Indicator">,</span> <span class="nv">1000</span><span class="p p-Indicator">]</span>
</code></pre></div>
Before running, let's verify the configuration file</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
triage experiment experiments/inspections_label_failed_01.yaml  --validate-only
</code></pre></div>
<p>You can execute the experiment with</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remember to run this in bastion  NOT in your laptop shell!</span>
<span class="nb">time</span> triage experiment experiments/inspections_label_failed_01.yaml
</code></pre></div>
<p>This will take a looooong time to run. The reason for that is easy to
understand: We are computing a <em>lot</em> of models: 6 time splits, 18 model
groups and 9 features sets (one for <code>all</code>, four for <code>leave_one_in</code> and
four for <code>leave_one_out</code>), so <span><span class="MathJax_Preview">6 \times 18 \times 9 = 486</span><script type="math/tex">6 \times 18 \times 9 = 486</script></span> extra
models.</p>
<p>Well, now we have a lot of models. How can you pick the best one? You
could try the following query:</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">features_groups</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">split_part</span><span class="p">(</span><span class="k">unnest</span><span class="p">(</span><span class="n">feature_list</span><span class="p">),</span> <span class="s1">'_'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">feature_groups</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">model_groups</span>
<span class="p">),</span>

<span class="n">features_arrays</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="k">distinct</span> <span class="n">feature_groups</span><span class="p">)</span> <span class="k">as</span> <span class="n">feature_groups</span>
<span class="k">from</span>
    <span class="n">features_groups</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">feature_groups</span><span class="p">,</span>
     <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">stochastic_value</span><span class="p">,</span> <span class="s1">'0.999'</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">'precision@'</span><span class="p">)</span> <span class="k">as</span> <span class="ss">"precision@15%"</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">to_char</span><span class="p">(</span><span class="n">stochastic_value</span><span class="p">,</span> <span class="s1">'0.999'</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span> <span class="k">asc</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">'recall@'</span><span class="p">)</span> <span class="k">as</span> <span class="ss">"recall@15%"</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">models</span>
    <span class="k">join</span>
    <span class="n">features_arrays</span> <span class="k">using</span><span class="p">(</span><span class="n">model_group_id</span><span class="p">)</span>
    <span class="k">join</span>
    <span class="n">test_results</span><span class="p">.</span><span class="n">evaluations</span> <span class="k">using</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<span class="k">where</span>
    <span class="n">model_comment</span> <span class="o">~</span> <span class="s1">'inspection'</span>
<span class="k">and</span>
    <span class="k">parameter</span> <span class="o">=</span> <span class="s1">'15_pct'</span>
<span class="k">group</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">feature_groups</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">model_group_id</span><span class="p">;</span>
</code></pre></div>
<details class="info"><summary>This is a long table …</summary><table>
<thead>
<tr>
<th>model_group_id</th>
<th>model_type</th>
<th>hyperparameters</th>
<th>feature_groups</th>
<th>precision@15%</th>
<th>recall@15%</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>sklearn.dummy.DummyClassifier</td>
<td>{"strategy": "prior"}</td>
<td>{inspections}</td>
<td>{" 0.339"," 0.366"," 0.378"}</td>
<td>{" 0.153"," 0.151"," 0.149"}</td>
</tr>
<tr>
<td>2</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max_depth": 2, "min_samples_split": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.347"," 0.394"," 0.466"}</td>
<td>{" 0.155"," 0.153"," 0.180"}</td>
</tr>
<tr>
<td>3</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max_depth": 2, "min_samples_split": 5}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.349"," 0.397"," 0.468"}</td>
<td>{" 0.156"," 0.154"," 0.181"}</td>
</tr>
<tr>
<td>4</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max_depth": 10, "min_samples_split": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.409"," 0.407"," 0.470"}</td>
<td>{" 0.179"," 0.163"," 0.178"}</td>
</tr>
<tr>
<td>5</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max_depth": 10, "min_samples_split": 5}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.416"," 0.409"," 0.454"}</td>
<td>{" 0.183"," 0.160"," 0.169"}</td>
</tr>
<tr>
<td>6</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max_depth": null, "min_samples_split": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.368"," 0.394"," 0.413"}</td>
<td>{" 0.165"," 0.161"," 0.160"}</td>
</tr>
<tr>
<td>7</td>
<td>sklearn.tree.DecisionTreeClassifier</td>
<td>{"max_depth": null, "min_samples_split": 5}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.386"," 0.397"," 0.417"}</td>
<td>{" 0.171"," 0.161"," 0.162"}</td>
</tr>
<tr>
<td>8</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.441"," 0.471"," 0.513"}</td>
<td>{" 0.190"," 0.187"," 0.193"}</td>
</tr>
<tr>
<td>9</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 2}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.470"," 0.478"," 0.532"}</td>
<td>{" 0.200"," 0.189"," 0.200"}</td>
</tr>
<tr>
<td>10</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 10}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.481"," 0.479"," 0.513"}</td>
<td>{" 0.204"," 0.189"," 0.193"}</td>
</tr>
<tr>
<td>11</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{inspection,inspections,results,risks}</td>
<td>{" 0.474"," 0.472"," 0.535"}</td>
<td>{" 0.202"," 0.183"," 0.199"}</td>
</tr>
<tr>
<td>12</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 2}</td>
<td>{inspections}</td>
<td>{" 0.428"," 0.417"," 0.389"}</td>
<td>{" 0.179"," 0.149"," 0.148"}</td>
</tr>
<tr>
<td>13</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 2}</td>
<td>{inspections}</td>
<td>{" 0.428"," 0.417"," 0.390"}</td>
<td>{" 0.180"," 0.149"," 0.148"}</td>
</tr>
<tr>
<td>14</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 10}</td>
<td>{inspections}</td>
<td>{" 0.427"," 0.417"," 0.376"}</td>
<td>{" 0.179"," 0.149"," 0.140"}</td>
</tr>
<tr>
<td>15</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{inspections}</td>
<td>{" 0.428"," 0.417"," 0.380"}</td>
<td>{" 0.179"," 0.149"," 0.143"}</td>
</tr>
<tr>
<td>16</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 2}</td>
<td>{results}</td>
<td>{" 0.415"," 0.398"," 0.407"}</td>
<td>{" 0.180"," 0.157"," 0.157"}</td>
</tr>
<tr>
<td>17</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 2}</td>
<td>{results}</td>
<td>{" 0.393"," 0.401"," 0.404"}</td>
<td>{" 0.171"," 0.158"," 0.155"}</td>
</tr>
<tr>
<td>18</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 10}</td>
<td>{results}</td>
<td>{" 0.436"," 0.425"," 0.447"}</td>
<td>{" 0.191"," 0.169"," 0.171"}</td>
</tr>
<tr>
<td>19</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{results}</td>
<td>{" 0.432"," 0.423"," 0.438"}</td>
<td>{" 0.188"," 0.168"," 0.167"}</td>
</tr>
<tr>
<td>20</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 2}</td>
<td>{risks}</td>
<td>{" 0.413"," 0.409"," 0.431"}</td>
<td>{" 0.184"," 0.170"," 0.166"}</td>
</tr>
<tr>
<td>21</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 2}</td>
<td>{risks}</td>
<td>{" 0.407"," 0.391"," 0.459"}</td>
<td>{" 0.180"," 0.159"," 0.179"}</td>
</tr>
<tr>
<td>22</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 10}</td>
<td>{risks}</td>
<td>{" 0.418"," 0.432"," 0.469"}</td>
<td>{" 0.184"," 0.176"," 0.181"}</td>
</tr>
<tr>
<td>23</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{risks}</td>
<td>{" 0.427"," 0.431"," 0.476"}</td>
<td>{" 0.187"," 0.176"," 0.183"}</td>
</tr>
<tr>
<td>24</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 2}</td>
<td>{inspection}</td>
<td>{" 0.435"," 0.483"," 0.483"}</td>
<td>{" 0.193"," 0.194"," 0.186"}</td>
</tr>
<tr>
<td>25</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 2}</td>
<td>{inspection}</td>
<td>{" 0.448"," 0.465"," 0.518"}</td>
<td>{" 0.196"," 0.188"," 0.202"}</td>
</tr>
<tr>
<td>26</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 10}</td>
<td>{inspection}</td>
<td>{" 0.446"," 0.446"," 0.508"}</td>
<td>{" 0.189"," 0.179"," 0.193"}</td>
</tr>
<tr>
<td>27</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{inspection}</td>
<td>{" 0.459"," 0.444"," 0.513"}</td>
<td>{" 0.198"," 0.176"," 0.198"}</td>
</tr>
<tr>
<td>28</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 2}</td>
<td>{inspection,results,risks}</td>
<td>{" 0.472"," 0.479"," 0.506"}</td>
<td>{" 0.202"," 0.191"," 0.190"}</td>
</tr>
<tr>
<td>29</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 2}</td>
<td>{inspection,results,risks}</td>
<td>{" 0.476"," 0.486"," 0.532"}</td>
<td>{" 0.202"," 0.191"," 0.199"}</td>
</tr>
<tr>
<td>30</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 10}</td>
<td>{inspection,results,risks}</td>
<td>{" 0.485"," 0.454"," 0.535"}</td>
<td>{" 0.203"," 0.180"," 0.204"}</td>
</tr>
<tr>
<td>31</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{inspection,results,risks}</td>
<td>{" 0.479"," 0.497"," 0.521"}</td>
<td>{" 0.205"," 0.193"," 0.196"}</td>
</tr>
<tr>
<td>32</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 2}</td>
<td>{inspection,inspections,risks}</td>
<td>{" 0.437"," 0.432"," 0.474"}</td>
<td>{" 0.191"," 0.178"," 0.181"}</td>
</tr>
<tr>
<td>33</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 2}</td>
<td>{inspection,inspections,risks}</td>
<td>{" 0.459"," 0.468"," 0.501"}</td>
<td>{" 0.202"," 0.191"," 0.197"}</td>
</tr>
<tr>
<td>34</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 10}</td>
<td>{inspection,inspections,risks}</td>
<td>{" 0.461"," 0.448"," 0.482"}</td>
<td>{" 0.201"," 0.181"," 0.187"}</td>
</tr>
<tr>
<td>35</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{inspection,inspections,risks}</td>
<td>{" 0.463"," 0.445"," 0.497"}</td>
<td>{" 0.200"," 0.180"," 0.189"}</td>
</tr>
<tr>
<td>36</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 2}</td>
<td>{inspection,inspections,results}</td>
<td>{" 0.462"," 0.448"," 0.513"}</td>
<td>{" 0.199"," 0.177"," 0.191"}</td>
</tr>
<tr>
<td>37</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 2}</td>
<td>{inspection,inspections,results}</td>
<td>{" 0.465"," 0.491"," 0.537"}</td>
<td>{" 0.197"," 0.190"," 0.203"}</td>
</tr>
<tr>
<td>38</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 10}</td>
<td>{inspection,inspections,results}</td>
<td>{" 0.459"," 0.481"," 0.522"}</td>
<td>{" 0.193"," 0.187"," 0.198"}</td>
</tr>
<tr>
<td>39</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{inspection,inspections,results}</td>
<td>{" 0.474"," 0.479"," 0.536"}</td>
<td>{" 0.203"," 0.188"," 0.201"}</td>
</tr>
<tr>
<td>40</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 2}</td>
<td>{inspections,results,risks}</td>
<td>{" 0.436"," 0.429"," 0.490"}</td>
<td>{" 0.189"," 0.174"," 0.185"}</td>
</tr>
<tr>
<td>41</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 2}</td>
<td>{inspections,results,risks}</td>
<td>{" 0.441"," 0.448"," 0.515"}</td>
<td>{" 0.190"," 0.180"," 0.194"}</td>
</tr>
<tr>
<td>42</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 100, "min_samples_split": 10}</td>
<td>{inspections,results,risks}</td>
<td>{" 0.460"," 0.475"," 0.481"}</td>
<td>{" 0.198"," 0.189"," 0.178"}</td>
</tr>
<tr>
<td>43</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{inspections,results,risks}</td>
<td>{" 0.465"," 0.446"," 0.496"}</td>
<td>{" 0.199"," 0.179"," 0.187"}</td>
</tr>
</tbody>
</table>
</details>
<p>This table summarizes all our experiments, but it is very difficult to
use if you want to choose the best combination of hyperparameters and
algorithm (i.e. the model group). In the next section
will solve this dilemma with the support of <code>audition</code>.</p>
<h2 id="selecting-the-best-model">Selecting the best model<a class="headerlink" href="#selecting-the-best-model" title="Permanent link">#</a></h2>
<p><strong>43</strong> <em>model groups</em>! How to pick the best one and use it for making
predictions with <em>new</em> data? What do you mean by “the best”? This is
not as easy as it sounds, due to several factors:</p>
<ul>
<li>You can try to pick the best using a metric specified in the
    config file (<code>precision@</code> and <code>recall@</code>), but at what point of
    time? Maybe different model groups are best at different
    prediction times.</li>
<li>You can just use the one that performs best on the last test set.</li>
<li>You can value a model group that provides consistent results over
    time. It might not be the best on any test set, but you can feel
    more confident that it will continue to perform similarly.</li>
<li>If there are several model groups that perform similarly and their
    lists are more or less similar, maybe it doesn't really matter
    which you pick.</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Remember…</p>
<p>Before move on, remember the two main <em>caveats</em> for the value of the metric in this kind of ML problems:</p>
<ul>
<li>Could be many entities with the same predicted risk score (<em>ties</em>)</li>
<li>Could be a lot of entities without a label (Weren't inspected, so we don’t know)</li>
</ul>
</div>
<p>We included a simple configuration file in <code>/triage/audition/inspection_audition_config.yaml</code>
with some rules:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># CHOOSE MODEL GROUPS</span>
<span class="nt">model_groups</span><span class="p">:</span>
    <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">select distinct(model_group_id)</span>
        <span class="no">from triage_metadata.model_groups</span>
        <span class="no">where model_config -&gt;&gt; 'experiment_type' ~ 'inspection'</span>
<span class="c1"># CHOOSE TIMESTAMPS/TRAIN END TIMES</span>
<span class="nt">time_stamps</span><span class="p">:</span>
    <span class="nt">query</span><span class="p">:</span> <span class="p p-Indicator">|</span>
        <span class="no">select distinct train_end_time</span>
        <span class="no">from triage_metadata.models</span>
        <span class="no">where model_group_id in ({})</span>
        <span class="no">and extract(day from train_end_time) in (1)</span>
        <span class="no">and train_end_time &gt;= '2014-01-01'</span>
<span class="c1"># FILTER</span>
<span class="nt">filter</span><span class="p">:</span>
    <span class="nt">metric</span><span class="p">:</span> <span class="s">'precision@'</span> <span class="c1"># metric of interest</span>
    <span class="nt">parameter</span><span class="p">:</span> <span class="s">'10_pct'</span> <span class="c1"># parameter of interest</span>
    <span class="nt">max_from_best</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0</span> <span class="c1"># The maximum value that the given metric can be worse than the best model for a given train end time.</span>
    <span class="nt">threshold_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0</span> <span class="c1"># The worst absolute value that the given metric should be.</span>
    <span class="nt">distance_table</span><span class="p">:</span> <span class="s">'inspections_distance_table'</span> <span class="c1"># name of the distance table</span>
    <span class="nt">models_table</span><span class="p">:</span> <span class="s">'models'</span> <span class="c1"># name of the models table</span>

<span class="c1"># RULES</span>
<span class="nt">rules</span><span class="p">:</span>
    <span class="p p-Indicator">-</span>
        <span class="nt">shared_parameters</span><span class="p">:</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">metric</span><span class="p">:</span> <span class="s">'precision@'</span>
                <span class="nt">parameter</span><span class="p">:</span> <span class="s">'10_pct'</span>

        <span class="nt">selection_rules</span><span class="p">:</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">'best_current_value'</span> <span class="c1"># Pick the model group with the best current metric value</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">'best_average_value'</span> <span class="c1"># Pick the model with the highest average metric value</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">'lowest_metric_variance'</span> <span class="c1"># Pick the model with the lowest metric variance</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="p p-Indicator">-</span>
                <span class="nt">name</span><span class="p">:</span> <span class="s">'most_frequent_best_dist'</span> <span class="c1"># Pick the model that is most frequently within `dist_from_best_case`</span>
                <span class="nt">dist_from_best_case</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0.05</span><span class="p p-Indicator">]</span>
                <span class="nt">n</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
</code></pre></div>
<p><code>Audition</code> will have each rule give you the best <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> <em>model groups</em>
based on the metric and parameter following that rule for the most
recent time period (in all the rules shown <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> = 3).</p>
<p>We can run the simulation of the rules against the experiment as:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Run this in bastion…</span>
triage --tb audition -c inspection_audition_config.yaml --directory audition/inspections
</code></pre></div>
<p><code>Audition</code> will create several plots that will help you to sort out
which is the <em>best</em> model group to use (like in a production setting
or just to generate your predictions list).</p>
<h3 id="filtering-model-groups">Filtering model groups<a class="headerlink" href="#filtering-model-groups" title="Permanent link">#</a></h3>
<p>Most of the time, <code>audition</code> should be used in a iterative fashion,
the result of each iteration will be a reduced set of models groups
and a best rule for selecting model groups.</p>
<p>If you look again at the <em>audition configuration
file</em> above
you can filter the number of models to consider using the parameters
<code>max_from_best</code> and <code>threshold_value</code>. The former will filter out
<em>models groups</em> with <em>models</em> which performance in the <code>metric</code> is
farther than the <code>max_from_best</code> (In this case we are allowing <strong>all</strong>
the models, since <code>max_from_best = 1.0</code>, if you want less models you
could choose <code>0.1</code> for example, and you will remove the
<code>DummyClassifier</code> and some
<code>DecisionTreeClassifiers</code>). <code>threshold_value</code> filter out all the
<em>models groups</em> with <em>models</em> performing <em>below</em> that the specified
value. This could be important if you <strong>don’t</strong> find acceptable models
with metrics that are that low.</p>
<p><code>Audition</code> will generate two plots that are meant to be used together:
<em>model performance over time</em> and <em>distance from best</em>.</p>
<p><img alt="img" src="../images/audition/inspections/metric_over_time_precision%4010_pct.png"/>
<em>Figure. Model group performance over time. In this case the metric
show is <code>precision@10%</code>. We didn’t filter out any model group, so the
45 model groups are shown. See discussion above to learn how to plot
less model groups. The black dashed line represents the (theoretical)
system's performance if we select the best performant model in a every
evaluation date. The colored lines represents different model
groups. All the model groups that share an algorithm will be colored
the same.</em></p>
<p>Next figure shows the proportion of <em>models</em> that are behind the best
model. The distance is measured in percentual points. You could use
this plot to <em>filter out</em> more model groups, changing the value of
<code>max_from_best</code> in the configuration file. This plot is hard to read,
but is very helpful since it shows you the <em>consistency</em> of the model
group: <em>How consistently are the model group in a specific range,
let's say 20 points, from the best?</em></p>
<p><img alt="img" src="../images/audition/inspections/distance_from_best_precision%4010_pct.png"/>
<em>Figure. Proportion of *models</em> in a <em>model group</em> that are separated
from the best model. The distance is measured in percentual points,
i.e. How much less precision at 10 percent of the population compared
to the best model in that date.*</p>
<p>In the figure, you can see that the ~60% of the <code>DummyClassifier</code>
models are ~18 percentual points below of the best.</p>
<h3 id="selecting-the-best-rule-or-strategy-for-choosing-model-groups">Selecting the best rule or strategy for choosing model groups<a class="headerlink" href="#selecting-the-best-rule-or-strategy-for-choosing-model-groups" title="Permanent link">#</a></h3>
<p>In this phase of the audition, you will see what will happen in the
next time if you choose your model group with an specific strategy or
rule. We call this the <strong>regret</strong> of the strategies.</p>
<p>We define <strong>regret</strong> as</p>
<div class="admonition quote">
<p><strong>Regret</strong> Is the difference in performance between the model group you picked and the best one in the next time period.</p>
</div>
<p>The next plot show the <em>best</em> model group selected by the strategies specified in the configuration file:</p>
<p><img alt="img" src="../images/audition/inspections/precision%4010_pct_next_time.png"/>
<em>Figure. Given a strategy for selecting model groups (in the figure, 4
are shown), What will be the performace of the model group chosen by
that strategy in the next evaluation date?</em></p>
<p>It seems that the strategies <em>best average</em> and <em>best current value</em>
select the same <strong>model group</strong>.</p>
<p><img alt="img" src="../images/audition/inspections/regret_distance_from_best_rules_precision%4010_pct.png"/>
<em>Figure. Given a strategy for selecting model groups (in the plot 4
are shown). What will be the distance (*regret</em>) to the best
theoretical model in the following evaluation date?*</p>
<p>Obviously, you don’t know the future, but with the available data, if
you stick to an a particular strategy, How much you will <em>regret</em>
about that decision?</p>
<p><img alt="img" src="../images/audition/inspections/regret_over_time_precision%4010_pct.png"/>
<em>Figure. Expected regret for the strategies. The less the better.</em></p>
<p>The best <strong>3</strong> <em>model groups</em> per strategy will be stored in the file <code>[[file:audition/inspections/results_model_group_ids.json][results_model_group_ids.json]]</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">"best_current_value_precision@_10_pct"</span><span class="p">:</span> <span class="p">[</span><span class="mi">39</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
    <span class="nt">"best_average_value_precision@_10_pct"</span><span class="p">:</span> <span class="p">[</span><span class="mi">39</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">29</span><span class="p">],</span>
    <span class="nt">"lowest_metric_variance_precision@_10_pct"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">19</span><span class="p">],</span>
    <span class="nt">"most_frequent_best_dist_precision@_10_pct_0.05"</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>The analysis suggests that the best strategies are</p>
<ul>
<li>select the model groups (<code>39,9,29</code>) which have the best average precision@10% value or,</li>
<li>select the best model group (<code>39,30,9</code>) using precision@10% today and use it for the next time period.</li>
</ul>
<p>You will note that both strategies share two models groups and differ
in one. In the next two sections, we will investigate further those
four model groups selected by <code>audition</code>, using the <em>Postmodeling</em>
tool set.</p>
<h2 id="postmodeling-inspecting-the-best-models-closely">Postmodeling: Inspecting the best models closely<a class="headerlink" href="#postmodeling-inspecting-the-best-models-closely" title="Permanent link">#</a></h2>
<p><em>Postmodeling</em> will help you to understand the behaviour orf your
selected models (from audition)</p>
<p>As in <code>Audition</code>, we will split the postmodeling process in two
parts. The first one is about exploring the <em>model groups</em> filtered by
audition, with the objective of select one. The second part is about
learning about <em>models</em> in the model group that was selected.</p>
<p>We will setup some parameters in the postmodeling configuration
file located at <code>/triage/postmodeling/inspection_postmodeling_config.yaml</code>,
mainly where is the audition’s output file located.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Postmodeling Configuration File</span>

<span class="nt">project_path</span><span class="p">:</span> <span class="s">'/triage'</span> <span class="c1"># Project path defined in triage with matrices and models</span>
<span class="nt">model_group_id</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">39</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">9</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">29</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">30</span>

<span class="nt">thresholds</span><span class="p">:</span> <span class="c1"># Thresholds for defining positive predictions</span>
  <span class="nt">rank_abs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">50</span><span class="p p-Indicator">,</span> <span class="nv">100</span><span class="p p-Indicator">,</span> <span class="nv">250</span><span class="p p-Indicator">]</span>
  <span class="nt">rank_pct</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">25</span><span class="p p-Indicator">]</span>

<span class="nt">baseline_query</span><span class="p">:</span> <span class="p p-Indicator">|</span> <span class="c1"># SQL query for defining a baseline for comparison in plots. It needs a metric and parameter</span>
      <span class="no">select g.model_group_id,</span>
             <span class="no">m.model_id,</span>
             <span class="no">extract('year' from m.evaluation_end_time) as as_of_date_year,</span>
             <span class="no">m.metric,</span>
             <span class="no">m.parameter,</span>
             <span class="no">m.value,</span>
             <span class="no">m.num_labeled_examples,</span>
             <span class="no">m.num_labeled_above_threshold,</span>
             <span class="no">m.num_positive_labels</span>
       <span class="no">from test_results.evaluations m</span>
       <span class="no">left join triage_metadata.models g</span>
       <span class="no">using(model_id)</span>
       <span class="no">where g.model_group_id = 1</span>
             <span class="no">and metric = 'precision@'</span>
             <span class="no">and parameter = '10_pct'</span>

<span class="nt">max_depth_error_tree</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span> <span class="c1"># For error trees, how depth the decision trees should go?</span>
<span class="nt">n_features_plots</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1"># Number of features for importances</span>
<span class="nt">figsize</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">12</span><span class="p p-Indicator">,</span> <span class="nv">12</span><span class="p p-Indicator">]</span> <span class="c1"># Default size for plots</span>
<span class="nt">fontsize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20</span> <span class="c1"># Default fontsize for plots</span>
</code></pre></div>
<p>Compared to the previous sections, <em>postmodeling</em> is not an automated process (yet). Hence, to do the following part of the tutorial, you need to run <code>jupyter</code> inside <code>bastion</code> as follows:</p>
<div class="highlight"><pre><span></span><code>jupyter-notebook –-ip<span class="o">=</span><span class="m">0</span>.0.0.0  --port<span class="o">=</span><span class="m">56406</span> --allow-root
</code></pre></div>
<p>And then in your browser type<sup id="fnref:11"><a class="footnote-ref" href="#fn:11">11</a></sup>: <a href="http://0.0.0.0:56406">http://0.0.0.0:56406</a></p>
<p>Now that you are in a jupyter notebook, type the following:</p>
<div class="highlight"><pre><span></span><code>%matplotlib inline
import matplotlib
#matplotlib.use('Agg')

import triage
import pandas as pd
import numpy as np

from collections import OrderedDict
from triage.component.postmodeling.contrast.utils.aux_funcs import create_pgconn, get_models_ids
from triage.component.catwalk.storage import ProjectStorage, ModelStorageEngine, MatrixStorageEngine
from triage.component.postmodeling.contrast.parameters import PostmodelParameters
from triage.component.postmodeling.contrast.model_evaluator import ModelEvaluator
from triage.component.postmodeling.contrast. model_group_evaluator import ModelGroupEvaluator
</code></pre></div>
<p>After importing, we need to create an <code>sqlalchemy engine</code> for connecting to the database, and read the configuration file.</p>
<div class="highlight"><pre><span></span><code>params = PostmodelParameters('inspection_postmodeling_config.yaml')
engine = create_pgconn('database.yaml')
</code></pre></div>
<p>Postmodeling provides the object <code>ModelGroupEvaluator</code> to compare different <em>model groups</em>.</p>
<div class="highlight"><pre><span></span><code>audited_models_class = ModelGroupEvaluator(tuple(params.model_group_id), engine)
</code></pre></div>
<h3 id="comparing-the-audited-model-groups">Comparing the audited model groups<a class="headerlink" href="#comparing-the-audited-model-groups" title="Permanent link">#</a></h3>
<p>First we will compare the performance of the audited model groups and the baseline over time. First, we will plot <code>precision@10_pct</code></p>
<div class="highlight"><pre><span></span><code>audited_models_class.plot_prec_across_time(param_type='rank_pct',
                                           param=10,
                                           baseline=True,
                                           baseline_query=params.baseline_query,
                                           metric='precision@',
                                               figsize=params.figsize)
</code></pre></div>
<p><img alt="img" src="../images/postmodeling/inspection_mg_prec_over_time.png"/>
<em>Figure. Precision@10% over time from the best performing model groups selected by Audition</em></p>
<p>and now the <code>recall@10_pct</code></p>
<div class="highlight"><pre><span></span><code>audited_models_class.plot_prec_across_time(param_type='rank_pct',
                                           param=10,
                                           metric='recall@',
                                           figsize=params.figsize)
</code></pre></div>
<p><img alt="img" src="../images/postmodeling/inspection_mg_recall_over_time.png"/>
<em>Figure. Recall@10% over time from the best performing model groups selected by Audition</em></p>
<p>All the selected model groups have a very similar performance. Let’s
see if they are predicting similar lists of facilities that are at
risk of fail an inspection.</p>
<div class="highlight"><pre><span></span><code>audited_models_class.plot_jaccard_preds(param_type='rank_pct',
                                        param=10,
                                        temporal_comparison=True)
</code></pre></div>
<p><img alt="img" src="../images/postmodeling/inspection_jaccard_on_lists_over_time.png"/>
<em>Figure. How similar are the model groups’ generated list? We use
Jaccard similarity on the predicted lists (length of list 10%) to
asses the overlap between lists.</em></p>
<p>The plot will shows the overlap of the predicted list containing the
10% of the facilities between model groups at each <em>as of date</em>. The
lists are at least 50% similar.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><em>Why the models are not learning the same?</em>
You should investigate why is that so. This could lead you
to defining new features or some another conclusion about your data,
but for this tutorial we will move on.</p>
</div>
<h3 id="going-deeper-with-a-model">Going deeper with a model<a class="headerlink" href="#going-deeper-with-a-model" title="Permanent link">#</a></h3>
<p>Imagine that after a deeper analysis, you decide to choose model group <strong>39</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">select</span>
    <span class="n">mg</span><span class="p">.</span><span class="n">model_group_id</span><span class="p">,</span>
    <span class="n">mg</span><span class="p">.</span><span class="n">model_type</span><span class="p">,</span>
    <span class="n">mg</span><span class="p">.</span><span class="n">hyperparameters</span><span class="p">,</span>
    <span class="n">array_agg</span><span class="p">(</span><span class="n">model_id</span> <span class="k">order</span> <span class="k">by</span> <span class="n">train_end_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">models</span>
<span class="k">from</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">model_groups</span> <span class="k">as</span> <span class="n">mg</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">triage_metadata</span><span class="p">.</span><span class="n">models</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">model_group_id</span><span class="p">)</span>
<span class="k">where</span> <span class="n">model_group_id</span> <span class="o">=</span> <span class="mi">39</span>
<span class="k">group</span> <span class="k">by</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_group_id</th>
<th>model_type</th>
<th>hyperparameters</th>
<th>models</th>
</tr>
</thead>
<tbody>
<tr>
<td>39</td>
<td>sklearn.ensemble.RandomForestClassifier</td>
<td>{"criterion": "gini", "max_features": "sqrt", "n_estimators": 250, "min_samples_split": 10}</td>
<td>{53,89,125}</td>
</tr>
</tbody>
</table>
<p>We will investigate what the particular models are doing. <em>Postmodeling</em> created a <code>ModelEvaluator</code> (similar to the <code>ModelGroupEvaluator</code>) to do this exploration:</p>
<div class="highlight"><pre><span></span><code>models_39 = { f'{model}': ModelEvaluator(39, model, engine) for model in [53,89,125] }
</code></pre></div>
<p>In this tutorial, we will just show some parts of the analysis in the
most recent model, but feel free of exploring the behavior of all the
models in this model group, and check if you can detect any pattern.</p>
<ul>
<li>
<p>Feature importances</p>
<div class="highlight"><pre><span></span><code>models_39['125'].plot_feature_importances(path=params.project_path,
                                          n_features_plots=params.n_features_plots,
                                          figsize=params.figsize)
</code></pre></div>
<p><img alt="img" src="../images/postmodeling/inspection_model_group_39_model_125_feature_importances.png"/>
<em>Figure. Top 10 feature importances for de model group 11 at 2016-06-01 (i.e. model 125).</em></p>
<div class="highlight"><pre><span></span><code>models_39['125'].plot_feature_group_aggregate_importances()
</code></pre></div>
<p><img alt="img" src="../images/postmodeling/inspection_model_group_39_model_125_feature_group_importances.png"/>
<em>Figure. Feature group “importance” (we are basically taking the
max of all the feature importances in a feature group) for the
model group 39, model 125.</em></p>
</li>
<li>
<p>Our <em>Policy menu</em></p>
<p>The following plot depicts the behavior of the metrics if you
change the length of the facilities predicted at risk (i.e. the
<span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span>). This plot is important from the decision making point of
view, since it could be used as a <em>policy menu</em>.</p>
<div class="highlight"><pre><span></span><code>models_39['125'].plot_precision_recall_n()
</code></pre></div>
<p><img alt="img" src="../images/postmodeling/inspection_model_group_39_model_125_rayid_curve.png"/>
<em>Figure. Plot of Precision and Recall over the proportion of the
facilities. This plot is used as a "policy menu" since allows you
to see how much you will gain if you invest more resources or how
much you will sacrifice if you reduce your budget for
resources. This is also known as “Rayid plot” at DSaPP.</em></p>
<p>We selected this model group because it was the best at precision
at 10% (i.e. the model group consistently chose facilities will
fail inspections at the top 10% of the risk). With the plot above
you could decide to double your resources (maybe hiring more
inspectors so you could inspect 20% of the facilities) and with
this model you will double the detection of facilities that will
fail inspections (from ~18% to ~30% in recall) with only a few
percent points less of precision ~45% to ~40% (this means that 6
in 10 facilities that the inspectors visit will pass the
inspection). You could also go the other way around: if you reduce
the length of the list from 10% to 5%, well you will gain a little
of precision, but your recall will be ~5%.</p>
</li>
</ul>
<h3 id="where-to-go-from-here">Where to go from here<a class="headerlink" href="#where-to-go-from-here" title="Permanent link">#</a></h3>
<p>Ready to get started with your own data? Check out <a href="https://dssg.github.io/triage/triage_project_workflow/">the suggested project workflow</a> for some tips about how to iterate and tune the pipeline for your project.</p>
<p>Want to work through another example? Take a look at our <a href="https://dssg.github.io/triage/dirtyduck/eis/">early warning system case study</a></p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p>If you assume a <em>uniform</em> distribution, it will make sense to select facilities at random. <a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:2">
<p>The underlying assumption here is that the City of Chicago is
<em>currently</em> doing <em>random</em> selection for the inspections. This is
not true (and probably unfair). In a real project, you will setup
a <strong>real</strong> baseline and you will compare your models against
it. This baseline could be a rule or a model. <a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn:3">
<p>You need to check this! Fortunately, <code>triage</code> allows you to try
several options here, so, if you think that this is too high or
too low you can change that and fit your needs. <a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn:4">
<p>Think about it: we <strong>can’t</strong> learn the relationship between the <em>features</em> and the <em>label</em> if we <strong>don't know</strong> the label. <a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
<li id="fn:5">
<p>Confused? Check <a href="../triage_intro/">A deeper look at triage</a> for
more details. <a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">↩</a></p>
</li>
<li id="fn:6">
<p>The formulas are, for <code>precision@k</code>, is the proportion of
facilities correctly identified in the top-<span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> facilities ranked
by risk:</p>
<p>$$
  precision@k = \frac{TP \in k}{k}
  $$</p>
<p>This is a measure about <em>how efficiently</em> are your system using your resources.</p>
<p><code>recall@k</code>, in the other hand is the proportion of <em>all</em> the facilities that are risk found in the top-<span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span></p>
<p>$$
  recall@k = \frac{TP \in k}{TP}
  $$</p>
<p><em>recall</em> is a measure about the <em>coverage</em> of your system, i.e. <em>how good is identifying in the top-<span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> the facilities at risk</em>.</p>
<p>One possible variation of this is to <strong>only</strong> include in the
  denominator the <em>labeled</em> rows in <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span>. <strong>This is the approach</strong> used by <code>triage</code>. <a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">↩</a></p>
</li>
<li id="fn:7">
<p>We will explore how to one way to tackle this in the advance part of this tutorial. <a class="footnote-backref" href="#fnref:7" title="Jump back to footnote 7 in the text">↩</a></p>
</li>
<li id="fn:8">
<p>The flags <code>-no-save-predictions</code> and <code>profile</code> are not necessary
but useful. The first one configure triage to not store the
predictions (at this stage you don't need them, and you can always
could recreate them from the model and the matrix). This will save
you execution time. The flag <code>profile</code> stores the <em>execution</em>
profile times in a file, so you can check which models or matrices
are taking a lot of time on been built. <a class="footnote-backref" href="#fnref:8" title="Jump back to footnote 8 in the text">↩</a></p>
</li>
<li id="fn:9">
<p>From a more mathematical point of view: Your data actually
reflects the empirical probability: <span><span class="MathJax_Preview">P(violation|inspected)</span><script type="math/tex">P(violation|inspected)</script></span>,
i.e. the probability of find a violation given that the facility
is inspected. But the probability that you want is
<span><span class="MathJax_Preview">P(violation)</span><script type="math/tex">P(violation)</script></span> (yes, I know that there are no such things as
unconditional probabilities, please bare with me),i.e. the
probability that the facility is in violation. <a class="footnote-backref" href="#fnref:9" title="Jump back to footnote 9 in the text">↩</a></p>
</li>
<li id="fn:10">
<p>You should see that this assumption is very dangerous in other settings, for example, crime prediction. <a class="footnote-backref" href="#fnref:10" title="Jump back to footnote 10 in the text">↩</a></p>
</li>
<li id="fn:11">
<p>This assumes that you are in a GNU/Linux machine, if not (you
should reconsider what are you doing with your life) you should
change the ip address (<code>0.0.0.0</code>) and use the one from the docker
virtual machine. <a class="footnote-backref" href="#fnref:11" title="Jump back to footnote 11 in the text">↩</a></p>
</li>
<li id="fn:12">
<p>For some reason, <code>sklearn</code> doesn’t scale the <em>inputs</em> to the
Logistic Regression, so we (DSaPP) developed a version that does that. <a class="footnote-backref" href="#fnref:12" title="Jump back to footnote 12 in the text">↩</a></p>
</li>
</ol>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav aria-label="Footer" class="md-footer-nav__inner md-grid">
<a class="md-footer-nav__link md-footer-nav__link--prev" href="../eis/" rel="prev" title="Early Warning System">
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                Early Warning System
              </div>
</div>
</a>
<a class="md-footer-nav__link md-footer-nav__link--next" href="../triage_intro/" rel="next" title="A deeper look into triage">
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Next
                </span>
                A deeper look into triage
              </div>
</div>
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
<div class="md-footer-social">
<a class="md-footer-social__link" href="https://github.com/dssg/triage" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://twitter.com/datascifellows" rel="noopener" target="_blank" title="twitter.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://linkedin.com/company/center-for-data-science-and-public-policy-university-of-chicago" rel="noopener" target="_blank" title="linkedin.com">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<script src="../../assets/javascripts/vendor.d710d30a.min.js"></script>
<script src="../../assets/javascripts/bundle.b39636ac.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
<script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
<script src="../../js/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>