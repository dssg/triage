
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Triage.">
      
      
      
        <link rel="canonical" href="http://dssg.github.io/triage/experiments/algorithm/">
      
      <link rel="icon" href="../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.12">
    
    
      
        <title>Experiment Algorithm - Triage Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.27ad92d8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../triage_docs.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#experiment-algorithm-deep-dive" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Triage Documentation" class="md-header__button md-logo" aria-label="Triage Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 22a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Triage Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Experiment Algorithm
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="http://github.com/dssg/triage" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    dssg/triage
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Triage Documentation" class="md-nav__button md-logo" aria-label="Triage Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 22a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12Z"/></svg>

    </a>
    Triage Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="http://github.com/dssg/triage" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    dssg/triage
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://colab.research.google.com/github/dssg/triage/blob/master/example/colab/colab_triage.ipynb" class="md-nav__link">
        Online Tutorial (Google Colab)
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Get started with your own project
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Get started with your own project" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Get started with your own project
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        Quickstart guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../triage_project_workflow/" class="md-nav__link">
        Suggested workflow
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Dirty Duck Tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Dirty Duck Tutorial" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Dirty Duck Tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/" class="md-nav__link">
        Welcome!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/dirty_duckling/" class="md-nav__link">
        Dirty duckling
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Case studies
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Case studies" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Case studies
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/problem_description/" class="md-nav__link">
        Problem description
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/eis/" class="md-nav__link">
        Early Warning System
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/inspections/" class="md-nav__link">
        Resource prioritization
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Triage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Triage" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Triage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/triage_intro/" class="md-nav__link">
        A deeper look into triage
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Are you curious about the setup?
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Are you curious about the setup?" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Are you curious about the setup?
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/infrastructure/" class="md-nav__link">
        Infrastructure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/data_preparation/" class="md-nav__link">
        Data preparation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/for_the_impatient/" class="md-nav__link">
        Quick setup
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Triage documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Triage documentation" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Triage documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_1">
          Experiment
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Experiment" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Experiment
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../experiment-config/" class="md-nav__link">
        Experiment Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature-testing/" class="md-nav__link">
        Testing Feature Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../running/" class="md-nav__link">
        Running an Experiment
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_4" type="checkbox" id="__nav_5_1_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_1_4">
          Upgrading an Experiment
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Upgrading an Experiment" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_4">
          <span class="md-nav__icon md-icon"></span>
          Upgrading an Experiment
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../upgrade-to-v8/" class="md-nav__link">
        v7 -> v8
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../upgrade-to-v7/" class="md-nav__link">
        v6 -> v7
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../upgrade-to-v6/" class="md-nav__link">
        v5 -> v6
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../upgrade-to-v5/" class="md-nav__link">
        v3/v4 -> v5
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../temporal-validation/" class="md-nav__link">
        Temporal Validation Deep Dive
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cohort-labels/" class="md-nav__link">
        Cohort and Label Deep Dive
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../prediction-ranking/" class="md-nav__link">
        Prediction Ranking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../features/" class="md-nav__link">
        Feature Generation Recipe Book
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Experiment Algorithm
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Experiment Algorithm
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-temporal-validation-setup" class="md-nav__link">
    1. Temporal Validation Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-transforming-data" class="md-nav__link">
    2. Transforming Data
  </a>
  
    <nav class="md-nav" aria-label="2. Transforming Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#labels" class="md-nav__link">
    Labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cohort-table" class="md-nav__link">
    Cohort Table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#features" class="md-nav__link">
    Features
  </a>
  
    <nav class="md-nav" aria-label="Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generating-aggregation-sql" class="md-nav__link">
    Generating Aggregation SQL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-group-wide-feature-tables" class="md-nav__link">
    Writing Group-wide Feature Tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#merging-into-aggregation-wide-feature-tables" class="md-nav__link">
    Merging into Aggregation-wide Feature Tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imputing-values" class="md-nav__link">
    Imputing Values
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recap" class="md-nav__link">
    Recap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-building-matrices" class="md-nav__link">
    3. Building Matrices
  </a>
  
    <nav class="md-nav" aria-label="3. Building Matrices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#feature-lists" class="md-nav__link">
    Feature Lists
  </a>
  
    <nav class="md-nav" aria-label="Feature Lists">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#feature-group-definition" class="md-nav__link">
    Feature Group Definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#feature-group-mixing" class="md-nav__link">
    Feature Group Mixing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iteration-and-matrix-creation" class="md-nav__link">
    Iteration and Matrix Creation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associating-matrices-with-experiment" class="md-nav__link">
    Associating Matrices with Experiment
  </a>
  
    <nav class="md-nav" aria-label="Associating Matrices with Experiment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#retrieving-data-and-saving-completed-matrix" class="md-nav__link">
    Retrieving Data and Saving Completed Matrix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recap_1" class="md-nav__link">
    Recap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-running-models" class="md-nav__link">
    4. Running Models
  </a>
  
    <nav class="md-nav" aria-label="4. Running Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#associating-models-with-experiment" class="md-nav__link">
    Associating Models with Experiment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#train" class="md-nav__link">
    Train
  </a>
  
    <nav class="md-nav" aria-label="Train">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model-groups" class="md-nav__link">
    Model Groups
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-hash" class="md-nav__link">
    Model Hash
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#global-feature-importance" class="md-nav__link">
    Global Feature Importance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-matrix" class="md-nav__link">
    Test Matrix
  </a>
  
    <nav class="md-nav" aria-label="Test Matrix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#predictions" class="md-nav__link">
    Predictions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#individual-feature-importance" class="md-nav__link">
    Individual Feature Importance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    Metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recap_2" class="md-nav__link">
    Recap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        Experiment Architecture
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_2">
          Model selection
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Model selection" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Model selection
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../audition/audition_intro/" class="md-nav__link">
        Intro to Audition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../audition/model_selection/" class="md-nav__link">
        Model Selection Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/audition/" class="md-nav__link">
        API Reference
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_3">
          Postmodeling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Postmodeling" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Postmodeling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../postmodeling/" class="md-nav__link">
        Using Postmodeling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../postmodeling/postmodeling-config/" class="md-nav__link">
        Postmodeling & Crosstabs Configuration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/ml_governance/" class="md-nav__link">
        Model governance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../predictlist/" class="md-nav__link">
        Predictlist
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dirtyduck/aws_batch/" class="md-nav__link">
        Scaling up
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db/" class="md-nav__link">
        Database Provisioner
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_8" type="checkbox" id="__nav_5_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_8">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_8">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_8_1" type="checkbox" id="__nav_5_8_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_8_1">
          Audition
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Audition" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_8_1">
          <span class="md-nav__icon md-icon"></span>
          Audition
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/audition/auditioner/" class="md-nav__link">
        Auditioner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/audition/audition-config/" class="md-nav__link">
        Audition Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/audition/selection_rules/" class="md-nav__link">
        Selection Rules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/audition/database-dependencies/" class="md-nav__link">
        Database Dependencies
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-temporal-validation-setup" class="md-nav__link">
    1. Temporal Validation Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-transforming-data" class="md-nav__link">
    2. Transforming Data
  </a>
  
    <nav class="md-nav" aria-label="2. Transforming Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#labels" class="md-nav__link">
    Labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cohort-table" class="md-nav__link">
    Cohort Table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#features" class="md-nav__link">
    Features
  </a>
  
    <nav class="md-nav" aria-label="Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generating-aggregation-sql" class="md-nav__link">
    Generating Aggregation SQL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-group-wide-feature-tables" class="md-nav__link">
    Writing Group-wide Feature Tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#merging-into-aggregation-wide-feature-tables" class="md-nav__link">
    Merging into Aggregation-wide Feature Tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imputing-values" class="md-nav__link">
    Imputing Values
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recap" class="md-nav__link">
    Recap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-building-matrices" class="md-nav__link">
    3. Building Matrices
  </a>
  
    <nav class="md-nav" aria-label="3. Building Matrices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#feature-lists" class="md-nav__link">
    Feature Lists
  </a>
  
    <nav class="md-nav" aria-label="Feature Lists">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#feature-group-definition" class="md-nav__link">
    Feature Group Definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#feature-group-mixing" class="md-nav__link">
    Feature Group Mixing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iteration-and-matrix-creation" class="md-nav__link">
    Iteration and Matrix Creation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associating-matrices-with-experiment" class="md-nav__link">
    Associating Matrices with Experiment
  </a>
  
    <nav class="md-nav" aria-label="Associating Matrices with Experiment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#retrieving-data-and-saving-completed-matrix" class="md-nav__link">
    Retrieving Data and Saving Completed Matrix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recap_1" class="md-nav__link">
    Recap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-running-models" class="md-nav__link">
    4. Running Models
  </a>
  
    <nav class="md-nav" aria-label="4. Running Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#associating-models-with-experiment" class="md-nav__link">
    Associating Models with Experiment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#train" class="md-nav__link">
    Train
  </a>
  
    <nav class="md-nav" aria-label="Train">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model-groups" class="md-nav__link">
    Model Groups
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-hash" class="md-nav__link">
    Model Hash
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#global-feature-importance" class="md-nav__link">
    Global Feature Importance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-matrix" class="md-nav__link">
    Test Matrix
  </a>
  
    <nav class="md-nav" aria-label="Test Matrix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#predictions" class="md-nav__link">
    Predictions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#individual-feature-importance" class="md-nav__link">
    Individual Feature Importance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    Metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recap_2" class="md-nav__link">
    Recap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="http://github.com/dssg/triage/edit/master/docs/sources/experiments/algorithm.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="experiment-algorithm-deep-dive">Experiment Algorithm Deep Dive<a class="headerlink" href="#experiment-algorithm-deep-dive" title="Permanent link">#</a></h1>
<p>This guide's purpose is to provide familiarity of the inner workings of a Triage Experiment to people with some
experience in data science and Python. A Triage Experiment is a highly structured way of defining the experimentation
phase of a data science project. To those wondering whether this Experiment structure is flexible enough to fit their
needs, this should help.</p>
<h2 id="1-temporal-validation-setup">1. Temporal Validation Setup<a class="headerlink" href="#1-temporal-validation-setup" title="Permanent link">#</a></h2>
<p>First, the given <code>temporal_config</code> section in the experiment definition is transformed into train and test splits,
including <code>as_of_times</code> for each matrix.</p>
<p>We create these splits by figuring out the latest reasonable split time from the inputs, and moving backwards in time
at the rate of the given <code>model_update_frequency</code>, until we get to the earliest reasonable split time.</p>
<p>For each split, we create <code>as_of_times</code> by moving either backwards from the split time towards the
<code>max_training_history</code> (for train matrices) or forwards from the split time towards the <code>test_duration</code> (for test
matrices) at the provided <code>data_frequency</code>.</p>
<p>Many of these configured values may be lists, in which case we generate the cross-product of all the possible values
and generate more splits.</p>
<p>For a more detailed look at the temporal validation logic, see <a href="../temporal-validation/">Temporal Validation Deep Dive</a>.</p>
<p>The train and test splits themselves are not used until the <a href="#3-building-matrices">Building Matrices</a> section, but a
flat list of all computed <code>as_of_times</code> for all matrices needed in the experiment is used in the next section,
<a href="#2-transforming-data">Transforming Data</a>.</p>
<h2 id="2-transforming-data">2. Transforming Data<a class="headerlink" href="#2-transforming-data" title="Permanent link">#</a></h2>
<p>With all of the <code>as_of_times</code> for this Experiment now computed, it's now possible to transform the input data into
features and labels as of all the required times.</p>
<h3 id="labels">Labels<a class="headerlink" href="#labels" title="Permanent link">#</a></h3>
<p>The Experiment populates a 'labels' table using the following input:
1. A query, provided by the user in the configuration file, that generates entity_ids and outcomes for a given
as_of_date and label_timespan.</p>
<ol>
<li>Each as_of_date and label_timespan defined in temporal config</li>
</ol>
<p>For instance, an inspections-style query (for the given timespan, return the entity and outcome of any matching
inspections) would look like:</p>
<div class="highlight"><pre><span></span><code>    select
    events.entity_id,
    bool_or(outcome::bool)::integer as outcome
    from events
    where &#39;{as_of_date}&#39; &lt;= outcome_date
        and outcome_date &lt; &#39;{as_of_date}&#39;::timestamp + interval &#39;{label_timespan}&#39;
        group by entity_id
</code></pre></div>
<p>This binary labels table is scoped to the entire Experiment, so all <code>as_of_time</code> (computed in step 1) and
<code>label_timespan</code> (taken straight from <code>temporal_config</code>) combinations are present. Additionally, the 'label_name' and
'label_type' are also recorded with each row in the table.</p>
<p>The name of the labels table is based on both the name of the label and a hash of the label query (e.g <code>labels_failedviolation_a0b1c2d3</code>), so any prior experiments that shared both the name and query will be able to reuse the labels table.  If the 'replace' flag was sent, for each <code>as_of_time</code> and <code>label_timespan</code>, the labels table is queried to check if any rows exist that match. If any such rows exist, the labels query for that date and timespan is not run.</p>
<p>At this point, the 'labels' table may not have entries for all entities and dates that need to be in a given matrix.
How these rows have their labels represented is up to the configured <code>include_missing_labels_in_train_as</code> value in the
experiment. This value is not processed when we generate the labels table, but later on when the matrix is built (see
'Retrieving Data and Saving Completed Matrix')</p>
<h3 id="cohort-table">Cohort Table<a class="headerlink" href="#cohort-table" title="Permanent link">#</a></h3>
<p>The Experiment keeps track of the which entities are in the cohort on any given date. Similarly to the labels table, the experiment populates a cohort table. using one of two options:</p>
<ol>
<li>
<p>A query, provided by the user in the configuration file, that generates entity_ids for a given as_of_date. This is run for each as_of_date as generated from the temporal config.</p>
</li>
<li>
<p>All distinct entity ids and as_of_dates in the labels table, if no query is provided by the user in the configuration file.</p>
</li>
</ol>
<p>This cohort table is scoped to the entire Experiment, so all <code>as_of_times</code> (computed in step 1) are present. </p>
<p>The name of the cohort table is based on both the name of the cohort and a hash of the cohort query (e.g <code>cohort_permitted_a0b1c2d3</code>), so any prior experiments that shared both the name and query will be able to reuse the cohort table.  If the 'replace' flag was sent, for each <code>as_of_time</code>, the cohort table is queried to check if any rows exist that match. If any such rows exist, the cohort query for that date is not run.</p>
<h3 id="features">Features<a class="headerlink" href="#features" title="Permanent link">#</a></h3>
<p>Each provided <code>feature_aggregation</code> configures the creation and population of several feature tables in the 'features'
schema: one for each of the groups specified in the config, one that merges the groups together into one table, and one
that fills in null values from the merged table with imputed values based on imputation config.</p>
<h4 id="generating-aggregation-sql">Generating Aggregation SQL<a class="headerlink" href="#generating-aggregation-sql" title="Permanent link">#</a></h4>
<p>To generate the SQL that creates the pre-imputation table, the Experiment assembles building blocks from the feature
aggregation config, as well as the experiment's list of <code>as_of_times</code>:</p>
<ul>
<li><code>from_obj</code> represents, well, the object of the FROM clause in the SQL query. Often this is just a table, but can be
configured to be a subquery. This holds all the data that we want to aggregate into features</li>
<li>Each <code>as_of_time</code> in the experiment and <code>interval</code> in the <code>feature_aggregation</code> is combined with the
<code>knowledge_date_column</code> to create a WHERE clause representing a valid window of events to aggregate in the <code>from_obj</code>:
e.g (<code>where {knowledge_date_column} &gt;= {as_of_time} - interval {interval}</code>)</li>
<li>Each <code>aggregate</code>, <code>categorical</code>, or <code>array_categorical</code> represents a SELECT clause. For aggregates, the <code>quantity</code> is
a column or SQL expression representing a numeric quantity present in the <code>from_obj</code>, and the <code>metrics</code> are any number
of aggregate functions we want to use. The aggregate function is applied to the quantity.</li>
<li>By default the query is joined with the cohort table to remove unnecessary rows. If <code>features_ignore_cohort</code> is passed to the Experiment this is not done.</li>
</ul>
<p>So a simplified version of a typical query would look like:
<div class="highlight"><pre><span></span><code>SELECT {group}, {metric}({quantity})
FROM {from_obj}
JOIN {cohort_table} ON (
    {cohort_table.entity_id} = {from_obj.entity_id}
    AND {cohort_table.date} = {as_of_time}
)
WHERE {knowledge_date_column} &gt;= {as_of_time} - interval {interval}
GROUP BY entity_id
</code></pre></div></p>
<h4 id="writing-group-wide-feature-tables">Writing Group-wide Feature Tables<a class="headerlink" href="#writing-group-wide-feature-tables" title="Permanent link">#</a></h4>
<p>For each <code>as_of_time</code>, the results from the generated query are written to a table whose name is prefixed with the
<code>prefix</code>, and suffixed with the <code>group</code> (always <code>entity_id</code> in <code>triage</code>). The table is keyed on this grouping column plus the as_of_date.</p>
<h4 id="merging-into-aggregation-wide-feature-tables">Merging into Aggregation-wide Feature Tables<a class="headerlink" href="#merging-into-aggregation-wide-feature-tables" title="Permanent link">#</a></h4>
<p>Each generated group table is combined into one representing the whole aggregation with a left join to ensure all valid entity/date pairs are included (allowing for identification of nulls requiring imputation). This aggregation-level table represents all of the features
in the aggregation, pre-imputation. Its output location is generally <code>{prefix}_aggregation</code></p>
<h4 id="imputing-values">Imputing Values<a class="headerlink" href="#imputing-values" title="Permanent link">#</a></h4>
<p>A table that looks similar, but with imputed values is created. The cohort table from above is passed into collate as
the comprehensive set of entities and dates for which output should be generated, regardless if they exist in the
<code>from_obj</code>. Each feature column has an imputation rule, inherited from some level of the feature definition. The
imputation rules that are based on data (e.g. <code>mean</code>) use the rows from the <code>as_of_time</code> to produce the imputed value. 
In addition, each column that needs imputation has an imputation flag column created, which contains a boolean flagging which rows were imputed or not. Since the values of these columns are redundant for most aggregate functions that look at a given timespan's worth of data (they will be imputed only if zero events in their timespan are seen), only one imputation flag column per timespan is created. An exception to this are some statistical functions that require not one, but two values, like standard deviation and variance. These boolean imputation flags are <em>not</em> merged in with the others.
Its output location is generally <code>{prefix}_aggregation_imputed</code></p>
<h3 id="recap">Recap<a class="headerlink" href="#recap" title="Permanent link">#</a></h3>
<p>At this point, we have at least three tables that are used to populate matrices:</p>
<ul>
<li><code>labels_{labelname}_{labelqueryhash}</code> with computed labels for each date</li>
<li><code>cohort_{cohortname}_{cohortqueryhash}</code> with the cohort for each date</li>
<li>A <code>features.{prefix}_aggregation_imputed</code> table for each feature aggregation present in the experiment config.</li>
</ul>
<h2 id="3-building-matrices">3. Building Matrices<a class="headerlink" href="#3-building-matrices" title="Permanent link">#</a></h2>
<p>At this point, we have to build actual train and test matrices that can be processed by machine learning algorithms, save at the user's specified path, either on the local filesystem or s3 depending on the scheme portion of the path (e.g. <code>s3://bucket-name/project_directory</code>)</p>
<p>First we have to figure out exactly what matrices we have to build. The split definitions from step 1 are a
good start -- they are our train and test splits -- but sometimes we also want to test different subsets of the data,
like feature groups (e.g. 'how does using group of features A perform against using all features?'). So there's a layer
of iteration we introduce for each split, that may produce many more matrices.</p>
<p>What do we iterate over?
* Feature List - All subsets of features that the user wants to cycle through. This is the end result of the feature
group generation and mixing process, which is described more below.
* Cohorts - In theory we can take in different cohorts and iterate in the same experiment.  This is not fully implemented, so in reality we just use the one cohort that is passed in the <code>cohort_config</code>
* Label names - In theory we can take in different labels (e.g. complaints, sustained complaints) in the same
experiment. Right now there is no support for multiple label names, but the label name used is configurable through the
optional 'label_config'-&gt;'name' config value
* Label types - In theory we can take in different label types (e.g. binary) in the same experiment. <em>Right now this
isn't done, there is one label type and it is hardcoded as 'binary'.</em></p>
<h3 id="feature-lists">Feature Lists<a class="headerlink" href="#feature-lists" title="Permanent link">#</a></h3>
<p>How do we arrive at the feature lists? There are two pieces of config that are used: <code>feature group_definition</code> and
<code>feature_group_strategies</code>. Feature group definitions are just ways to define logical blocks of features, most often
features that come from the same source, or describing a particular type of event. These groups within the experiment
as a list of feature names, representing some subset of all potential features for the experiment. Feature group
strategies are ways to take feature groups and mix them together in various ways. The feature group strategies take
these subsets of features and convert them into another list of subsets of features, which is the final list iterated
over to create different matrices.</p>
<h4 id="feature-group-definition">Feature Group Definition<a class="headerlink" href="#feature-group-definition" title="Permanent link">#</a></h4>
<p>Feature groups, at present, can be defined as either a <code>prefix</code> (the prefix of the feature name), a <code>table</code> (the
feature table that the feature resides in), or <code>all</code> (all features).  Each argument is passed as a list, and each entry
in the list is interpreted as a group. So, a feature group config of <code>{'table': ['complaints_aggregate_imputed',
'incidents_aggregate_imputed']}</code> would result in two feature groups: one with all the features in
<code>complaints_aggregate_imputed</code>, and one with all the features in <code>incidents_aggregate_imputed</code>. Note that this requires
a bit of knowledge on the user's part of how the feature table names will be constructed.</p>
<p><code>prefix</code> works on the prefix of the feature name as it exists in the database. So this also requires some knowledge of
how these get created. The general format is: <code>{aggregation_prefix}_{group}_{timeperiod}_{quantity}</code>, so with some
knowledge the user can create groups with the aggregation's configured prefix (common), or the aggregations configured
prefix + group (in case they want to compare, for instance, zip-code level features versus entity level features).</p>
<p><code>all</code>, with a single value of <code>True</code>, will include a feature group with all defined features. If no feature group
definition is sent, this is the default.</p>
<p>Either way, at the end of this process the experiment will be aware of some list of feature groups, even if the list is
just length 1 with all features as one group.</p>
<h4 id="feature-group-mixing">Feature Group Mixing<a class="headerlink" href="#feature-group-mixing" title="Permanent link">#</a></h4>
<p>A few basic feature group mixing strategies are implemented: <code>leave-one-in</code>, <code>leave-one-out</code>, and <code>all</code>. These are sent
in the experiment definition as a list, so different strategies can be tried in the same experiment. Each included
strategy will be applied to the list of feature groups from the previous step, to convert them into</p>
<p>For instance, 'leave-one-in' will cycle through each feature group, and for each one create a list of features that
just represents that feature group, so for some matrices we would only use features from that particular group.
<code>leave-one-out</code> does the opposite, for each feature group creating a list of features that includes all other feature
groups but that one. <code>all</code> just creates a list of features that represents all feature groups together.</p>
<h3 id="iteration-and-matrix-creation">Iteration and Matrix Creation<a class="headerlink" href="#iteration-and-matrix-creation" title="Permanent link">#</a></h3>
<p>At this point, matrices are created by looping through all train/test splits and data subsets (e.g. feature groups,
state definitions), grabbing the data corresponding to each from the database, and assembling that data into a design
matrix that is saved along with the metadata that defines it.</p>
<p>As an example, if the experiment defines 3 train/test splits (one test per train in this example, for simplicity), 3
feature groups that are mixed using the 'leave-one-out' and 'all' strategies, and 1 state definition, we'll expect 18
matrices to be saved: 9 splits after multiplying the time splits by the feature groups, and each one creating a train
and test matrix.</p>
<h3 id="associating-matrices-with-experiment">Associating Matrices with Experiment<a class="headerlink" href="#associating-matrices-with-experiment" title="Permanent link">#</a></h3>
<p>After all matrices for the Experiment are defined but before any are built, the Experiment is associated with each Matrix in the database through the <code>triage_metadata.experiment_matrices</code> table. This means that whether or not the Experiment has to end up building a matrix, after the fact a user can query the database to see if it used said matrix.</p>
<h4 id="retrieving-data-and-saving-completed-matrix">Retrieving Data and Saving Completed Matrix<a class="headerlink" href="#retrieving-data-and-saving-completed-matrix" title="Permanent link">#</a></h4>
<p>Each matrix that has to be built (i.e. has not been built by some prior experiment) is built by retrieving its data out of the database.</p>
<p>How do we get the data for an individual matrix out of the database?</p>
<ol>
<li>
<p>Create an entity-date table for this specific matrix. There is some logic applied to decide what rows show up. There
are two possible sets of rows that could show up.</p>
</li>
<li>
<p><code>all valid entity dates</code>. These dates come from the entity-date-state table for the experiment (populated using the
rules defined in the 'cohort_config'), filtered down to the entity-date pairs that match both <em>the state filter and the
list of as-of-dates for this matrix</em>.</p>
</li>
<li>
<p><code>all labeled entity dates</code>. These dates consist of all the valid entity dates from above, that also have an entry in
the labels table.</p>
</li>
</ol>
<p>If the matrix is a test matrix, all valid entity dates will be present.</p>
<p>If the matrix is a train matrix, whether or not valid but unlabeled examples show up is decided by the
<code>include_missing_labels_in_train_as</code> configuration value. If it is present in any form, these labels will be in the
matrix. Otherwise, they will be filtered out.</p>
<ol>
<li>
<p>Write features data from tables to disk in CSV format using a COPY command, table by table. Each table is joined
with the matrix-specific entity-date table to only include the desired rows.</p>
</li>
<li>
<p>Write labels data to disk in CSV format using a COPY command. These labels will consist of the rows in the
matrix-specific entity-date table left joined to the labels table. Rows not present in the labels table will have their
label filled in (either True or False) based on the value of the <code>include_missing_labels_in_train_as</code> configuration key.</p>
</li>
<li>
<p>Merge the features and labels CSV files horizontally, in pandas. They are expected to be of the same shape, which is
enforced by the entity-date table. The resulting matrix is indexed on <code>entity_id</code> and <code>as_of_date</code>, and then saved to
disk (in CSV format, more formats to come) along with its metadata: time, feature, label, index, and state information.
along with any user metadata the experiment config specified. The filename is decided by a hash of this metadata, and
the metadata is saved in a YAML file with the same hash and directory. The metadata is additionally added to a database table 'matrices'.</p>
</li>
</ol>
<p>Matrix metadata reference:
- <a href="https://github.com/dssg/timechop/blob/master/timechop/timechop.py#L433-L440">Train matrix temporal info</a>
- <a href="https://github.com/dssg/timechop/blob/master/timechop/timechop.py#L514-L523">Test matrix temporal info</a>
- <a href="https://github.com/dssg/triage/blob/master/src/triage/component/architect/planner.py#L89-L112">Feature, label, index, cohort, user
metadata</a></p>
<h3 id="recap_1">Recap<a class="headerlink" href="#recap_1" title="Permanent link">#</a></h3>
<p>At this point, all finished matrices and metadata will be saved under the <code>project_path</code> supplied by the user to the
Experiment constructor, in the subdirectory <code>matrices</code>.</p>
<h2 id="4-running-models">4. Running Models<a class="headerlink" href="#4-running-models" title="Permanent link">#</a></h2>
<p>The last phase of an Experiment run uses the completed design matrices to train, test, and evaluate classifiers. This procedure writes a lot of metadata to the 3 schemas: 'triage_metadata', 'train_results', and 'test_results'.</p>
<h3 id="associating-models-with-experiment">Associating Models with Experiment<a class="headerlink" href="#associating-models-with-experiment" title="Permanent link">#</a></h3>
<p>Every combination of training matrix + classifier + hyperparameter is considered a Model. Before any Models are trained, the Experiment is associated with each Model in the database through the <code>triage_metadata.experiment_models</code> table. This means that whether or not the Experiment has to end up training a model, after the fact a user can query the database to see if it used said model.</p>
<h3 id="train">Train<a class="headerlink" href="#train" title="Permanent link">#</a></h3>
<p>Each matrix marked for training is sent through the configured grid in the experiment's <code>grid_config</code>. This works much
like the scikit-learn <code>ParameterGrid</code> (and in fact uses it on the backend). It cycles through all of the classifiers
and hyperparameter combinations contained herein, and calls <code>.fit()</code> with that train matrix. Any classifier that
adheres to the scikit-learn <code>.fit/.transform</code> interface and is available in the Python environment will work here,
whether it is a standard scikit-learn classifier, a third-party library like XGBoost, or a custom-built one in the
calling repository (for instance, one that implements the problem domain's baseline heuristic algorithm for
comparison).  Metadata about the trained classifier is written to the <code>triage_metadata.models</code> Postgres table. The trained model is saved to a filename with the model hash (see Model Hash section below).</p>
<h4 id="model-groups">Model Groups<a class="headerlink" href="#model-groups" title="Permanent link">#</a></h4>
<p>Each model is assigned a 'model group'. A model group represents a number of trained classifiers that we want to treat
as equivalent by some criteria. By default, this is aimed at defining models which are equivalent across time splits,
to make analyzing model stability easier. This default is accomplished with a set of 'model group keys' that includes
data about the classifier (module, hyperparameters), temporal intervals used to create the train matrix (label
timespan, training history, as-of-date frequency), and metadata describing the data in the train matrix (features and
feature groups, label name, cohort name). The user can override this set of <code>model_group_keys</code> in the experiment
definition, with all of the default information plus other matrix metadata at their disposal (See end of 'Retrieving
Data and Saving Completed Matrix' section for more about matrix metadata). This data is stored in the <code>triage_metadata.model_groups</code> table, along with a <code>model_group_id</code> that is used as a foreign key in the <code>triage_metadata.models</code> table.</p>
<h4 id="model-hash">Model Hash<a class="headerlink" href="#model-hash" title="Permanent link">#</a></h4>
<p>Each trained model is assigned a hash, for the purpose of uniquely defining and caching the model. This hash is based
on the training matrix metadata, classifier path, hyperparameters (except those which concern execution and do not
affect results of the classifier, such as <code>n_jobs</code>), and the given project path for the Experiment. This hash can be
found in each row of the <code>triage_metadata.models</code> table. It is enforced as a unique key in the table.</p>
<h4 id="global-feature-importance">Global Feature Importance<a class="headerlink" href="#global-feature-importance" title="Permanent link">#</a></h4>
<p>The training phase also writes global feature importances to the database, in the <code>train_results.feature_importances</code> table.
A few methods are queried to attempt to compute feature importances:
* The bulk of these are computed using the trained model's <code>.feature_importances_</code> attribute, if it exists.
* For sklearn's <code>SVC</code> models with a linear kernel, the model's <code>.coef_.squeeze()</code> is used.
* For sklearn's LogisticRegression models, <code>np.exp(model.coef_).squeeze()</code> is used.
* Otherwise, no feature importances are written.</p>
<h3 id="test-matrix">Test Matrix<a class="headerlink" href="#test-matrix" title="Permanent link">#</a></h3>
<p>For each test matrix, predictions, individual importances, and the user-specified testing evaluation metrics are written to the 'test_results' schema. For each train matrix, predictions and the user-specified training evaluation metrics are written to the 'train_results' schema.</p>
<h4 id="predictions">Predictions<a class="headerlink" href="#predictions" title="Permanent link">#</a></h4>
<p>The trained model's prediction probabilities (<code>predict_proba()</code>) are computed both for the matrix it was trained on and any testing matrices. The predictions for the training matrix are saved in <code>train_results.predictions</code> and those for the testing matrices are saved in the <code>test_results.predictions</code>. More specifically, <code>predict_proba</code> returns the probabilities for each label (false and true), but in this case only the probabilities for the true label are saved in the <code>{train or test}_predictions</code> table. The <code>entity_id</code> and <code>as_of_date</code> are retrieved from the matrix's index, and stored in the database table along with the probability score, label value (if it has one), as well as other metadata.</p>
<h3 id="individual-feature-importance">Individual Feature Importance<a class="headerlink" href="#individual-feature-importance" title="Permanent link">#</a></h3>
<p>Feature importances (of a configurable number of top features, defaulting to 5) for each prediction are computed and written to the <code>test_results.individual_importances</code> table. Right now, there are no sophisticated calculation methods integrated into the experiment; simply the top 5 global feature importances for the model are copied to the <code>individual_importances</code> table.</p>
<h3 id="metrics">Metrics<a class="headerlink" href="#metrics" title="Permanent link">#</a></h3>
<p>Triage allows for the computation of both testing set and training set evaluation metrics. Evaluation metrics, such as precision and recall at various thresholds, are written to either the <code>train_results.evaluations</code> table or the <code>test_results.evaluations</code>. Triage defines a number of <a href="https://github.com/dssg/triage/blob/master/src/triage/component/catwalk/evaluation.py#L45-L58">Evaluation Metrics</a> metrics that can be addressed by name in the experiment definition, along with a list of thresholds and/or other parameters (such as the 'beta' value for fbeta) to iterate through.</p>
<p>Thresholding is done either via absolute value (top k) or percentile by sorting the predictions and labels by the row's predicted probability score, with ties broken in some way (see next paragraph), and assigning the predicted value as True for those above the threshold. Note that the percentile thresholds are in terms of the population percentage, not a cutoff threshold for the predicted probability.</p>
<p>A few different versions of tiebreaking are implemented to deal with the nuances of thresholding, and each result is written to the evaluations table for each metric score, along with some related statistics:</p>
<ul>
<li><code>worst_value</code> - Ordering by the label ascending. This has the effect of as many predicted negatives making it above thresholds as possible, thus producing the worst possible score.</li>
<li><code>best_value</code> - Ordering by the label descending. This has the effect of as many predicted positives making it above thresholds as possible, thus producing the best possible score.</li>
<li><code>stochastic_value</code> - If the <code>worst_value</code> and <code>best_value</code> are not the same (as defined by the floating point tolerance at catwalk.evaluation.RELATIVE_TOLERANCE), the sorting/thresholding/evaluation will be redone many times, and the mean of all these trials is written to this column. Otherwise, the <code>worst_value</code> is written here</li>
<li><code>num_sort_trials</code> - If trials are needed to produce the <code>stochastic_value</code>, the number of trials taken is written here. Otherwise this will be 0</li>
<li><code>standard_deviation</code> - If trials are needed to produce the <code>stochastic_value</code>, the standard deviation of these trials is written here. Otherwise this will be 0</li>
</ul>
<p>Sometimes test matrices may not have labels for every row, so it's worth mentioning here how that is handled and interacts with thresholding. Rows with missing labels are not considered in the metric calculations, and if some of these rows are in the top k of the test matrix, no more rows are taken from the rest of the list for consideration. So if the experiment is calculating precision at the top 100 rows, and 40 of the top 100 rows are missing a label, the precision will actually be calculated on the 60 of the top 100 rows that do have a label. To make the results of this more transparent for users, a few extra pieces of metadata are written to the evaluations table for each metric score.</p>
<ul>
<li><code>num_labeled_examples</code> - The number of rows in the test matrix that have labels</li>
<li><code>num_labeled_above_threshold</code> - The number of rows above the configured threshold for this metric score that have
labels</li>
<li><code>num_positive_labels</code> - The number of positive labels in the test matrix</li>
</ul>
<p>Triage supports performing a bias audit using the Aequitas library, if a <code>bias_audit_config</code> is passed in configuration. This is handled first through creating a 'protected groups'table which retrieves the configured protected group information for each member of the cohort, and the time that this protected group information was first known. This table is named using a hash of the bias audit configuration, so data can be reused across experiments as long as the bias configuration does not change.</p>
<p>A bias audit is performed alongside metric calculation time for each model that is built, on both the train and test matrices, and each subset. This is very similar to the evaluations table schema, in that for each slice of data that has evaluation metrics generated for it, also receives a bias audit. The change is that thresholds are not borrowed from the evaluation configuration, as aequitas audits are computationally expensive and large threshold grids are common in Triage experiments; the bias audit has its evaluation thresholds configured in the <code>bias_audit_config</code>. All data from the bias audit is saved to either the <code>train_results.aequitas</code> or <code>test_results.aequitas</code> tables.</p>
<p>Triage also supports evaluating a model on a subset of the predictions made.
This is done by passing a subset query in the prediction config. The model
evaluator will then subset the predictions on valid entity-date pairs for the
given model and will calculate metrics for the subset, re-applying thresholds
as necessary to the predictions in the subset. Subset definitions are stored in
the <code>triage_metadata.subsets</code> table, and the evaluations are stored in the
<code>evaluations</code> tables. A hash of the subset configuration identifies subset
evaluations and links the <code>subsets</code> table.</p>
<h3 id="recap_2">Recap<a class="headerlink" href="#recap_2" title="Permanent link">#</a></h3>
<p>At this point, the 'triage_metadata', 'train_results', and 'test_results' database schemas are fully populated with data about models, model groups, predictions, feature importances, and evaluation metrics for the researcher to query. In addition, the trained model pickle files are saved in the configured project path. The experiment is considered finished.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../features/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Feature Generation Recipe Book" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Feature Generation Recipe Book
            </div>
          </div>
        </a>
      
      
        
        <a href="../architecture/" class="md-footer__link md-footer__link--next" aria-label="Next: Experiment Architecture" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Experiment Architecture
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/dssg/triage" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/datascifellows" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://linkedin.com/company/center-for-data-science-and-public-policy-university-of-chicago" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ed9748b7.min.js"></script>
      
        <script src="../../js/mermaid.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>